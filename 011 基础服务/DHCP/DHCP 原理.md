# DHCP 原理

### DHCP 概述

　　DHCP (Dynamic Host Configuration Protocol)，动态主机配置协议是应用层上一种客户端/服务器协议，用于**动态分配 IP 地址**与网关等参数到 DHCP 客户端。

　　DHCP 主要是为计算机自动提供 IP 地址、子网掩码和网关。网络管理员会分配某个范围的 IP  地址来分发给局域网上的客户机，当设备接入这个局域网时，会向 DHCP 服务器请求一个 IP 地址。然后 DHCP  服务器为每个请求的设备分配一个地址，直到分配完该范围内的所有 IP 地址为止。已经分配的 IP 地址必须定时地延长借用期，这个延期的过程称做  leasing。

### DHCP 特点

* DHCP 最大的功能就是动态分配，除了 IP 地址，DHCP 还为客户端提供其他的配置信息，比如子网掩码、网关等，客户端自动配置后就可以连接到网络。
* DHCP 可以确保同一时刻一个 IP 地址只分配给一个用户。
* DHCP 可以为特定的用户分配固定的 IP 地址。

### DHCP 工作流程

　　用户端主机通过 UDP 广播的形式向本地网络中所有设备发送请求数据包，当 DHCP  服务器收到请求后根据自身的配置信息将分配给客户端的信息发送给客户端主机，其中的租赁期是有限的。一旦租赁期到期，服务端会回收相关的 IP  地址，所以客户端在租凭过半的时候会向服务器发送更新租约的请求，从而继续使用相关的 IP 地址。

　　如下图所示为通过 DHCP 获取 IP 的过程：

1. DHCP 发现阶段

    客户端以广播方式（因为 DHCP 服务器的 IP 地址对于客户端来说是未知的）发送 DHCP discover 信息来查找 DHCP 服务器。

2. DHCP 提供阶段

    在网络中接收到 DHCP discover 数据包的 DHCP 服务器都会做出响应。它从尚未出租的 IP 地址池中挑选一个分配给 DHCP 客户端，并且发送一个包含要分配的 IP 地址以及一些其他配置信息的 DHCP offer 数据包给客户端。

3. DHCP 选择阶段

    如果有多台 DHCP 服务器向 DHCP 客户端发送 DHCP offer 数据包，则 DHCP 客户端只接受第 1 个收到的 DHCP offer 信息（**即先到先得**）。然后它就以广播方式回复一个 DHCP request 数据包，该数据包中包含向它所选定的 DHCP 服务器的 IP 地址与被分配的 IP 地址信息。之所以要以广播方式回答，是为了通知所有 DHCP 服务器。

4. DHCP 确认阶段

    当 DHCP 服务器收到 DHCP 客户端回答的 DHCP request 数据包之后，会确认 request 数据包中的 DHCP  服务端 IP 地址是否与自己的相同，若是不同则删除自己记录中的分配记录，所以除 DHCP 客户端选中的服务器外，其他的 DHCP  服务器都将收回曾提供的 IP 地址。若是相同它会向 DHCP 客户端发送一个包含其所提供的 IP 地址和租凭时间等其他信息的 DHCP ACK  数据包，告诉 DHCP 客户端可以使用该 IP 地址。

5. DHCP 请求阶段（DHCP information）

    DHCP 客户端在接收到服务端的 ACK 数据包之后，检查分配的 IP 地址是否能够使用，若是能够使用则成功获得 IP  地址，并会根据租凭信息中的租约时间自动更新、延续租凭时间，若是 IP 地址不能够使用，则会发送 DHCP Decline 的数据包告知 DHCP 禁用该 IP 地址，然后重新申请 IP 地址。或者是获取更多的其他信息，如代理等信息。

6. DHCP 更新租约

    DHCP 服务器向 DHCP 客户端出租的 IP 地址一般都有一个租借期限，期满后 DHCP 服务器便会收回该 IP 地址。如果 DHCP 客户端要延长其 IP 租约，则必须向 DHCP server 端发送更新其 IP 租约的请求数据包。DHCP 客户端在 IP  租约期限过一半时，DHCP 客户端都会自动向 DHCP 服务器发送更新其 IP 租约的信息。
