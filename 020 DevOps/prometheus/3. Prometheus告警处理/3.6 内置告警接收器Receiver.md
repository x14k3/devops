# 3.6 å†…ç½®å‘Šè­¦æ¥æ”¶å™¨Receiver

â€

å‰ä¸Šä¸€å°èŠ‚å·²ç»è®²è¿‡ï¼Œåœ¨Alertmanagerä¸­è·¯ç”±è´Ÿè´£å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œåˆ†ç»„åŒ¹é…ï¼Œå¹¶å°†åƒå‘Šè­¦æ¥æ”¶å™¨å‘é€é€šçŸ¥ã€‚å‘Šè­¦æ¥æ”¶å™¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å½¢å¼è¿›è¡Œé…ç½®ï¼š

```
receivers:
  - <receiver> ...
```

æ¯ä¸€ä¸ªreceiverå…·æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åç§°ï¼Œå¹¶ä¸”å¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€šçŸ¥æ–¹å¼ï¼š

```
name: <string>
email_configs:
  [ - <email_config>, ... ]
hipchat_configs:
  [ - <hipchat_config>, ... ]
pagerduty_configs:
  [ - <pagerduty_config>, ... ]
pushover_configs:
  [ - <pushover_config>, ... ]
slack_configs:
  [ - <slack_config>, ... ]
opsgenie_configs:
  [ - <opsgenie_config>, ... ]
webhook_configs:
  [ - <webhook_config>, ... ]
victorops_configs:
  [ - <victorops_config>, ... ]
```

ç›®å‰å®˜æ–¹å†…ç½®çš„ç¬¬ä¸‰æ–¹é€šçŸ¥é›†æˆåŒ…æ‹¬ï¼šé‚®ä»¶ã€ å³æ—¶é€šè®¯è½¯ä»¶ï¼ˆå¦‚Slackã€Hipchatï¼‰ã€ç§»åŠ¨åº”ç”¨æ¶ˆæ¯æ¨é€(å¦‚Pushover)å’Œè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ˆä¾‹å¦‚ï¼šPagerdutyã€Opsgenieã€Victoropsï¼‰ã€‚Alertmanagerçš„é€šçŸ¥æ–¹å¼ä¸­è¿˜å¯ä»¥æ”¯æŒWebhookï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¼€å‘è€…å¯ä»¥å®ç°æ›´å¤šä¸ªæ€§åŒ–çš„æ‰©å±•æ”¯æŒã€‚

## ä¸SMTPé‚®ä»¶é›†æˆ

é‚®ç®±åº”è¯¥æ˜¯ç›®å‰ä¼ä¸šæœ€å¸¸ç”¨çš„å‘Šè­¦é€šçŸ¥æ–¹å¼ï¼ŒAlertmanagerå†…ç½®äº†å¯¹SMTPåè®®çš„æ”¯æŒï¼Œå› æ­¤å¯¹äºä¼ä¸šç”¨æˆ·è€Œè¨€ï¼Œåªéœ€è¦ä¸€äº›åŸºæœ¬çš„é…ç½®å³å¯å®ç°é€šè¿‡é‚®ä»¶çš„é€šçŸ¥ã€‚

åœ¨Alertmanagerä½¿ç”¨é‚®ç®±é€šçŸ¥ï¼Œç”¨æˆ·åªéœ€è¦å®šä¹‰å¥½SMTPç›¸å…³çš„é…ç½®ï¼Œå¹¶ä¸”åœ¨receiverä¸­å®šä¹‰æ¥æ”¶æ–¹çš„é‚®ä»¶åœ°å€å³å¯ã€‚åœ¨Alertmanagerä¸­æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨é…ç½®æ–‡ä»¶çš„globalä¸­å®šä¹‰å…¨å±€çš„SMTPé…ç½®ï¼š

```
global:
  [ smtp_from: <tmpl_string> ]
  [ smtp_smarthost: <string> ]
  [ smtp_hello: <string> | default = "localhost" ]
  [ smtp_auth_username: <string> ]
  [ smtp_auth_password: <secret> ]
  [ smtp_auth_identity: <string> ]
  [ smtp_auth_secret: <secret> ]
  [ smtp_require_tls: <bool> | default = true ]
```

å®Œæˆå…¨å±€SMTPä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºreceiveré…ç½®email_configsç”¨äºå®šä¹‰ä¸€ç»„æ¥æ”¶å‘Šè­¦çš„é‚®ç®±åœ°å€å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
name: <string>
email_configs:
  [ - <email_config>, ... ]
```

æ¯ä¸ªemail_configä¸­å®šä¹‰ç›¸åº”çš„æ¥æ”¶äººé‚®ç®±åœ°å€ï¼Œé‚®ä»¶é€šçŸ¥æ¨¡æ¿ç­‰ä¿¡æ¯å³å¯ï¼Œå½“ç„¶å¦‚æœå½“å‰æ¥æ”¶äººéœ€è¦å•ç‹¬çš„SMTPé…ç½®ï¼Œé‚£ç›´æ¥åœ¨email_configä¸­è¦†ç›–å³å¯ï¼š

```
[ send_resolved: <boolean> | default = false ]
to: <tmpl_string>
[ html: <tmpl_string> | default = '{{ template "email.default.html" . }}' ]
[ headers: { <string>: <tmpl_string>, ... } ]
```

å¦‚æœå½“å‰æ”¶ä»¶äººéœ€è¦æ¥å—å‘Šè­¦æ¢å¤çš„é€šçŸ¥çš„è¯ï¼Œåœ¨email_configä¸­å®šä¹‰`send_resolved`â€‹ä¸ºtrueå³å¯ã€‚

å¦‚æœæ‰€æœ‰çš„é‚®ä»¶é…ç½®ä½¿ç”¨äº†ç›¸åŒçš„SMTPé…ç½®ï¼Œåˆ™å¯ä»¥ç›´æ¥å®šä¹‰å…¨å±€çš„SMTPé…ç½®ã€‚

è¿™é‡Œï¼Œä»¥Gmailé‚®ç®±ä¸ºä¾‹ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå…¨å±€çš„SMTPé…ç½®ï¼Œå¹¶ä¸”é€šè¿‡routeå°†æ‰€æœ‰å‘Šè­¦ä¿¡æ¯å‘é€åˆ°default-receiverä¸­:

```
global:
  smtp_smarthost: smtp.gmail.com:587
  smtp_from: <smtp mail from>
  smtp_auth_username: <usernae>
  smtp_auth_identity: <username>
  smtp_auth_password: <password>

route:
  group_by: ['alertname']
  receiver: 'default-receiver'

receivers:
  - name: default-receiver
    email_configs:
      - to: <mail to address>
        send_resolved: true
```

> éœ€è¦æ³¨æ„çš„æ˜¯æ–°çš„Googleè´¦å·å®‰å…¨è§„åˆ™éœ€è¦ä½¿ç”¨â€åº”ç”¨ä¸“æœ‰å¯†ç â€œä½œä¸ºé‚®ç®±ç™»å½•å¯†ç 

è¿™æ—¶å¦‚æœæ‰‹åŠ¨æ‹‰é«˜ä¸»æœºCPUä½¿ç”¨ç‡ï¼Œä½¿å¾—ç›‘æ§æ ·æœ¬æ•°æ®æ»¡è¶³å‘Šè­¦è§¦å‘æ¡ä»¶ã€‚åœ¨SMTPé…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¥æ”¶åˆ°å¦‚ä¸‹çš„å‘Šè­¦å†…å®¹ï¼š

![mail-alert-page](assets/mail-alert-page-20230802143320-odxyq8l.png)

â€

## ä¸Slacké›†æˆ

Slackæ˜¯éå¸¸æµè¡Œçš„å›¢é˜Ÿæ²Ÿé€šåº”ç”¨ï¼Œæä¾›ç¾¤ç»„èŠå¤©å’Œç›´æ¥æ¶ˆæ¯å‘é€åŠŸèƒ½ï¼Œæ”¯æŒç§»åŠ¨ç«¯ï¼ŒWeb å’Œæ¡Œé¢å¹³å°ã€‚åœ¨å›½å¤–æœ‰å¤§é‡çš„ITå›¢é˜Ÿä½¿ç”¨Slackä½œä¸ºå›¢é˜Ÿåä½œå¹³å°ã€‚åŒæ—¶å…¶æä¾›äº†å¼ºå¤§çš„é›†æˆèƒ½åŠ›ï¼Œåœ¨Slackçš„åŸºç¡€ä¸Šä¹Ÿè¡ç”Ÿå‡ºäº†å¤§é‡çš„ChatOpsç›¸å…³çš„æŠ€æœ¯å®è·µã€‚è¿™éƒ¨åˆ†å°†ä»‹ç»å¦‚ä½•å°†Slacké›†æˆåˆ°Alertmanagerä¸­ã€‚

### è®¤è¯†Slack

![slack-overview](assets/slack-overview-20230802143436-b822a3f.png)

Slackä½œä¸ºä¸€æ¬¾å³æ—¶é€šè®¯å·¥å…·ï¼Œåä½œæ²Ÿé€šä¸»è¦é€šè¿‡Channelï¼ˆå¹³å°ï¼‰æ¥å®Œæˆï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¼ä¸šä¸­æ ¹æ®ç”¨é€”æ·»åŠ å¤šä¸ªChannelï¼Œå¹¶ä¸”é€šè¿‡Channelæ¥é›†æˆå„ç§ç¬¬ä¸‰æ–¹å·¥å…·ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºç›‘æ§å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„Channelç”¨äºæ¥æ”¶å„ç§ç›‘æ§ä¿¡æ¯ï¼š

![slack-create-channel](assets/slack-create-channel-20230802143452-0yubr6v.png)

é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„Channleå¯ä»¥å‡å°‘ä¿¡æ¯å¯¹ç”¨æˆ·å·¥ä½œçš„å¹²æ‰°ï¼Œå¹¶ä¸”å°†ç›¸å…³ä¿¡æ¯èšåˆåœ¨ä¸€èµ·ï¼š

![slack-channel](assets/slack-channel-20230802143505-q0325kt.png)

Slackçš„å¼ºå¤§ä¹‹å¤„åœ¨äºåœ¨Channelä¸­æ·»åŠ å„ç§ç¬¬ä¸‰æ–¹æœåŠ¡çš„é›†æˆï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥åŸºäºSlackå¼€å‘è‡ªå·±çš„èŠå¤©æœºå™¨äººæ¥å®ç°ä¸€äº›æ›´é«˜çº§çš„èƒ½åŠ›ï¼Œä¾‹å¦‚è‡ªåŠ¨åŒ–è¿ç»´ï¼Œæé«˜å¼€å‘æ•ˆç‡ç­‰ã€‚

### æ·»åŠ åº”ç”¨ï¼šIncomming Webhooks

ä¸ºäº†èƒ½å¤Ÿåœ¨Monitoringä¸­æ¥æ”¶æ¥è‡ªAlertmanagerçš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Channelçš„è®¾ç½®é€‰é¡¹ä¸­ä½¿ç”¨"Add an App"ä¸ºMonitoring channelæ·»åŠ ä¸€ä¸ªåä¸º`Incoming WebHooks`â€‹çš„åº”ç”¨ï¼š

![add-incomming-webhooks](assets/add-incomming-webhooks-20230802143517-1ncqod1.png)

æ·»åŠ æˆåŠŸåSlackä¼šæ˜¾ç¤º`Incoming WebHooks`â€‹é…ç½®å’Œä½¿ç”¨æ–¹å¼ï¼š

![incomming-webhooks-setting](assets/incomming-webhooks-setting-20230802143529-ww4yh2b.png)

Incomming Webhookçš„å·¥ä½œæ–¹å¼å¾ˆç®€å•ï¼ŒSlackä¸ºå½“å‰Channelåˆ›å»ºäº†ä¸€ä¸ªç”¨äºæ¥æ”¶æ¶ˆæ¯çš„APIåœ°å€ï¼š

```
https://hooks.slack.com/services/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
```

ç”¨æˆ·åªéœ€è¦ä½¿ç”¨Postæ–¹å¼å‘Channelå‘é€éœ€è¦é€šçŸ¥çš„æ¶ˆæ¯å³å¯ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­é€šè¿‡curlæ¨¡æ‹Ÿä¸€æ¬¡æ¶ˆæ¯é€šçŸ¥ï¼š

```
curl -d "payload={'text': 'This is a line of text in a channel.\nAnd this is another line of text.'}" https://hooks.slack.com/services/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
```

åœ¨ç½‘ç»œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œåœ¨Channelä¸­ä¼šæ˜¾ç¤ºæ–°çš„é€šçŸ¥ä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![slack-receiver-message](assets/slack-receiver-message-20230802143550-iahgaiu.png)

é™¤äº†å‘é€çº¯æ–‡æœ¬ä»¥å¤–ï¼Œslackè¿˜æ”¯æŒåœ¨æ–‡æœ¬å†…å®¹ä¸­æ·»åŠ é“¾æ¥ï¼Œä¾‹å¦‚ï¼š

```
payload={"text": "A very important thing has occurred! <https://alert-system.com/alerts/1234|Click here> for details!"}
```

æ­¤æ—¶æ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­å»ºè¾‰åŒ…å«ä¸€ä¸ªå¯ç‚¹å‡»çš„è¶…é“¾æ¥åœ°å€ã€‚é™¤äº†payloadä»¥å¤–ï¼ŒIncomming Webhhookè¿˜æ”¯æŒä¸€äº›å…¶ä»–çš„å‚æ•°ï¼š

|å‚æ•°|ä½œç”¨|ç¤ºä¾‹|
| ------------| ----------------------------------------------------------------| ----------------------------|
|username|è®¾ç½®å½“å‰èŠå¤©æœºå™¨äººçš„åç§°|webhookbot|
|icon_url|å½“å‰èŠå¤©æœºå™¨äººçš„å¤´åƒåœ°å€|[https://slack.com/img/icons/app-57.png](https://slack.com/img/icons/app-57.png)|
|icon_emoji|ä½¿ç”¨emojiä½œä¸ºèŠå¤©æœºå™¨äººçš„å¤´åƒ|ğŸ‘»|
|channel|æ¶ˆæ¯å‘é€çš„ç›®æ ‡channel, éœ€è¦ç›´æ¥å‘ç»™ç‰¹å®šç”¨æˆ·æ—¶ä½¿ç”¨@usernameå³å¯|#monitoring æˆ–è€… @username|

ä¾‹å¦‚ï¼Œä½¿ç”¨ä»¥ä¸Šå‚æ•°å‘é€ä¸€æ¡æ›´æœ‰è¶£çš„æ¶ˆæ¯ï¼š

```
curl -X POST --data-urlencode "payload={'channel': '#monitoring', 'username': 'webhookbot', 'text': 'This is posted to #monitoring and comes from a bot named webhookbot.', 'icon_emoji': ':ghost:'}" https://hooks.slack.com/services/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
```

![custom-slack-message](assets/custom-slack-message-20230802143602-bcagn05.png)

### åœ¨Alertmanagerä¸­ä½¿ç”¨Slack

åœ¨äº†è§£äº†Slackä»¥åŠIncomming Webhhookçš„åŸºæœ¬ä½¿ç”¨æ–¹å¼åï¼Œåœ¨Alertmanagerä¸­æ·»åŠ Slackæ”¯æŒå°±éå¸¸ç®€å•äº†ã€‚

åœ¨Alertmanagerçš„å…¨å±€é…ç½®ä¸­ï¼Œå°†Incomming Webhhookåœ°å€ä½œä¸ºslack_api_urlæ·»åŠ åˆ°å…¨å±€é…ç½®ä¸­å³å¯ï¼š

```
global:
  slack_api_url: https://hooks.slack.com/services/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
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªreceiverä¸­å•ç‹¬å®šä¹‰è‡ªå·±çš„slack_configså³å¯ï¼š

```
receiversï¼š
- name: slack
  slack_configs:
    - channel: '#monitoring'
      send_resolved: true
```

è¿™é‡Œå¦‚æœæˆ‘ä»¬æ‰‹åŠ¨æ‹‰é«˜å½“å‰ä¸»æœºçš„CPUåˆ©ç”¨ç‡ï¼Œåœ¨#Monitoringå¹³å°ä¸­ï¼Œæˆ‘ä»¬ä¼šæ¥æ”¶åˆ°ä¸€æ¡å‘Šè­¦ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š

![slack_alert_message](assets/slack_alert_message-20230802143614-5nabpsx.png)

è€Œå½“å‘Šè­¦é¡¹æ¢å¤æ­£å¸¸åï¼Œåˆ™å¯ä»¥æ¥æ”¶åˆ°å¦‚ä¸‹é€šçŸ¥ï¼š

![slack_resolved_message](assets/slack_resolved_message-20230802143622-yuh65bz.png)

å¯¹äºIncomming Webhhookæ”¯æŒçš„å…¶å®ƒè‡ªå®šä¹‰å‚æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨slack_configä¸­è¿›è¡Œå®šä¹‰ï¼Œslack_configçš„ä¸»è¦é…ç½®å¦‚ä¸‹ï¼š

```
channel: <tmpl_string>
[ send_resolved: <boolean> | default = false ]
[ api_url: <secret> | default = global.slack_api_url ]
[ icon_emoji: <tmpl_string> ]
[ icon_url: <tmpl_string> ]
[ link_names: <boolean> | default = false ]
[ username: <tmpl_string> | default = '{{ template "slack.default.username" . }}' ]
[ color: <tmpl_string> | default = '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}' ]
[ footer: <tmpl_string> | default = '{{ template "slack.default.footer" . }}' ]
[ pretext: <tmpl_string> | default = '{{ template "slack.default.pretext" . }}' ]
[ text: <tmpl_string> | default = '{{ template "slack.default.text" . }}' ]
[ title: <tmpl_string> | default = '{{ template "slack.default.title" . }}' ]
[ title_link: <tmpl_string> | default = '{{ template "slack.default.titlelink" . }}' ]
[ image_url: <tmpl_string> ]
[ thumb_url: <tmpl_string> ]
```

å¦‚æœè¦è¦†ç›–é»˜è®¤çš„å‘Šè­¦å†…å®¹ï¼Œç›´æ¥ä½¿ç”¨Go Templateå³å¯ã€‚ä¾‹å¦‚ï¼š

```
color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
```

â€

## ä¸ä¼ä¸šå¾®ä¿¡é›†æˆ

Alertmanagerå·²ç»å†…ç½®äº†å¯¹ä¼ä¸šå¾®ä¿¡çš„æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ä¸šå¾®ä¿¡æ¥ç®¡ç†æŠ¥è­¦ï¼Œæ›´è¿›ä¸€æ­¥å¯ä»¥é€šè¿‡ä¼ä¸šå¾®ä¿¡å’Œå¾®ä¿¡çš„äº’é€šæ¥ç›´æ¥å°†å‘Šè­¦æ¶ˆæ¯è½¬å‘åˆ°ä¸ªäººå¾®ä¿¡ä¸Šã€‚

[prometheuså®˜ç½‘](https://prometheus.io/docs/alerting/configuration/#wechat_config)ä¸­ç»™å‡ºäº†ä¼ä¸šå¾®ä¿¡çš„ç›¸å…³é…ç½®è¯´æ˜

```
# Whether or not to notify about resolved alerts.
[ send_resolved: <boolean> | default = false ]

# The API key to use when talking to the WeChat API.
[ api_secret: <secret> | default = global.wechat_api_secret ]

# The WeChat API URL.
[ api_url: <string> | default = global.wechat_api_url ]

# The corp id for authentication.
[ corp_id: <string> | default = global.wechat_api_corp_id ]

# API request data as defined by the WeChat API.
[ message: <tmpl_string> | default = '{{ template "wechat.default.message" . }}' ]
[ agent_id: <string> | default = '{{ template "wechat.default.agent_id" . }}' ]
[ to_user: <string> | default = '{{ template "wechat.default.to_user" . }}' ]
[ to_party: <string> | default = '{{ template "wechat.default.to_party" . }}' ]
[ to_tag: <string> | default = '{{ template "wechat.default.to_tag" . }}' ]
```

ä¼ä¸šå¾®ä¿¡ç›¸å…³æ¦‚å¿µè¯´æ˜è¯·å‚è€ƒ[ä¼ä¸šå¾®ä¿¡APIè¯´æ˜](https://work.weixin.qq.com/api/doc#90000/90135/90665)ï¼Œå¯ä»¥åœ¨ä¼ä¸šå¾®ä¿¡çš„åå°ä¸­å»ºç«‹å¤šä¸ªåº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨å¯¹åº”ä¸åŒçš„æŠ¥è­¦åˆ†ç»„ï¼Œç”±ä¼ä¸šå¾®ä¿¡æ¥åšæ¥æ”¶æˆå‘˜çš„åˆ’åˆ†ã€‚å…·ä½“é…ç½®å‚è€ƒå¦‚ä¸‹ï¼š

```
global:
  resolve_timeout: 10m
  wechat_api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
  wechat_api_secret: 'åº”ç”¨çš„secretï¼Œåœ¨åº”ç”¨çš„é…ç½®é¡µé¢å¯ä»¥çœ‹åˆ°'
  wechat_api_corp_id: 'ä¼ä¸šidï¼Œåœ¨ä¼ä¸šçš„é…ç½®é¡µé¢å¯ä»¥çœ‹åˆ°'
templates:
- '/etc/alertmanager/config/*.tmpl'
route:
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  routes:
  - receiver: 'wechat'
    continue: true
inhibit_rules:
- source_match:
receivers:
- name: 'wechat'
  wechat_configs:
  - send_resolved: false
    corp_id: 'ä¼ä¸šidï¼Œåœ¨ä¼ä¸šçš„é…ç½®é¡µé¢å¯ä»¥çœ‹åˆ°'
    to_user: '@all'
    to_party: ' PartyID1 | PartyID2 '
    message: '{{ template "wechat.default.message" . }}'
    agent_id: 'åº”ç”¨çš„AgentIdï¼Œåœ¨åº”ç”¨çš„é…ç½®é¡µé¢å¯ä»¥çœ‹åˆ°'
    api_secret: 'åº”ç”¨çš„secretï¼Œåœ¨åº”ç”¨çš„é…ç½®é¡µé¢å¯ä»¥çœ‹åˆ°'
```

é…ç½®æ¨¡æ¿ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
{{ define "wechat.default.message" }}
{{- if gt (len .Alerts.Firing) 0 -}}
{{- range $index, $alert := .Alerts -}}
{{- if eq $index 0 -}}
å‘Šè­¦ç±»å‹: {{ $alert.Labels.alertname }}
å‘Šè­¦çº§åˆ«: {{ $alert.Labels.severity }}

=====================
{{- end }}
===å‘Šè­¦è¯¦æƒ…===
å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}
æ•…éšœæ—¶é—´: {{ $alert.StartsAt.Format "2006-01-02 15:04:05" }}
===å‚è€ƒä¿¡æ¯===
{{ if gt (len $alert.Labels.instance) 0 -}}æ•…éšœå®ä¾‹ip: {{ $alert.Labels.instance }};{{- end -}}
{{- if gt (len $alert.Labels.namespace) 0 -}}æ•…éšœå®ä¾‹æ‰€åœ¨namespace: {{ $alert.Labels.namespace }};{{- end -}}
{{- if gt (len $alert.Labels.node) 0 -}}æ•…éšœç‰©ç†æœºip: {{ $alert.Labels.node }};{{- end -}}
{{- if gt (len $alert.Labels.pod_name) 0 -}}æ•…éšœpodåç§°: {{ $alert.Labels.pod_name }}{{- end }}
=====================
{{- end }}
{{- end }}

{{- if gt (len .Alerts.Resolved) 0 -}}
{{- range $index, $alert := .Alerts -}}
{{- if eq $index 0 -}}
å‘Šè­¦ç±»å‹: {{ $alert.Labels.alertname }}
å‘Šè­¦çº§åˆ«: {{ $alert.Labels.severity }}

=====================
{{- end }}
===å‘Šè­¦è¯¦æƒ…===
å‘Šè­¦è¯¦æƒ…: {{ $alert.Annotations.message }}
æ•…éšœæ—¶é—´: {{ $alert.StartsAt.Format "2006-01-02 15:04:05" }}
æ¢å¤æ—¶é—´: {{ $alert.EndsAt.Format "2006-01-02 15:04:05" }}
===å‚è€ƒä¿¡æ¯===
{{ if gt (len $alert.Labels.instance) 0 -}}æ•…éšœå®ä¾‹ip: {{ $alert.Labels.instance }};{{- end -}}
{{- if gt (len $alert.Labels.namespace) 0 -}}æ•…éšœå®ä¾‹æ‰€åœ¨namespace: {{ $alert.Labels.namespace }};{{- end -}}
{{- if gt (len $alert.Labels.node) 0 -}}æ•…éšœç‰©ç†æœºip: {{ $alert.Labels.node }};{{- end -}}
{{- if gt (len $alert.Labels.pod_name) 0 -}}æ•…éšœpodåç§°: {{ $alert.Labels.pod_name }};{{- end }}
=====================
{{- end }}
{{- end }}
{{- end }}
```

è¿™æ—¶å¦‚æœæŸä¸€å®¹å™¨é¢‘ç¹é‡å¯ï¼Œå¯ä»¥æ¥æ”¶åˆ°å¦‚ä¸‹çš„å‘Šè­¦å†…å®¹ï¼š

![wechat-alert-page](assets/wechat-alert-page-20230802143724-w2spqtn.png)

## ä½¿ç”¨Webhookæ‰©å±•Alertmanager

åœ¨æŸäº›æƒ…å†µä¸‹é™¤äº†Alertmanagerå·²ç»å†…ç½®çš„é›†ä¸­å‘Šè­¦é€šçŸ¥æ–¹å¼ä»¥å¤–ï¼Œå¯¹äºä¸åŒçš„ç”¨æˆ·å’Œç»„ç»‡è€Œè¨€è¿˜éœ€è¦ä¸€äº›è‡ªå®šä¹‰çš„å‘ŠçŸ¥æ–¹å¼æ”¯æŒã€‚é€šè¿‡Alertmanageræä¾›çš„webhookæ”¯æŒå¯ä»¥è½»æ¾å®ç°è¿™ä¸€ç±»çš„æ‰©å±•ã€‚é™¤äº†ç”¨äºæ”¯æŒé¢å¤–çš„é€šçŸ¥æ–¹å¼ï¼Œwebhookè¿˜å¯ä»¥ä¸å…¶ä»–ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆå®ç°è¿ç»´è‡ªåŠ¨åŒ–ï¼Œæˆ–è€…å¼¹æ€§ä¼¸ç¼©ç­‰ã€‚

åœ¨Alertmanagerä¸­å¯ä»¥ä½¿ç”¨å¦‚ä¸‹é…ç½®å®šä¹‰åŸºäºwebhookçš„å‘Šè­¦æ¥æ”¶å™¨receiverã€‚ä¸€ä¸ªreceiverå¯ä»¥å¯¹åº”ä¸€ç»„webhooké…ç½®ã€‚

```
name: <string>
webhook_configs:
  [ - <webhook_config>, ... ]
```

æ¯ä¸€é¡¹webhook_configçš„å…·ä½“é…ç½®æ ¼å¼å¦‚ä¸‹ï¼š

```
# Whether or not to notify about resolved alerts.
[ send_resolved: <boolean> | default = true ]

# The endpoint to send HTTP POST requests to.
url: <string>

# The HTTP client's configuration.
[ http_config: <http_config> | default = global.http_config ]
```

send_resolvedç”¨äºæŒ‡å®šæ˜¯å¦åœ¨å‘Šè­¦æ¶ˆé™¤æ—¶å‘é€å›æ‰§æ¶ˆæ¯ã€‚urlåˆ™æ˜¯ç”¨äºæ¥æ”¶webhookè¯·æ±‚çš„åœ°å€ã€‚http_configsåˆ™æ˜¯åœ¨éœ€è¦å¯¹è¯·æ±‚è¿›è¡ŒSSLé…ç½®æ—¶ä½¿ç”¨ã€‚

å½“ç”¨æˆ·å®šä¹‰webhookç”¨äºæ¥æ”¶å‘Šè­¦ä¿¡æ¯åï¼Œå½“å‘Šè­¦è¢«è§¦å‘æ—¶ï¼ŒAlertmanagerä¼šæŒ‰ç…§ä»¥ä¸‹æ ¼å¼å‘è¿™äº›urlåœ°å€å‘é€HTTP Postè¯·æ±‚ï¼Œè¯·æ±‚å†…å®¹å¦‚ä¸‹ï¼š

```
{
  "version": "4",
  "groupKey": <string>,    // key identifying the group of alerts (e.g. to deduplicate)
  "status": "<resolved|firing>",
  "receiver": <string>,
  "groupLabels": <object>,
  "commonLabels": <object>,
  "commonAnnotations": <object>,
  "externalURL": <string>,  // backlink to the Alertmanager.
  "alerts": [
    {
      "labels": <object>,
      "annotations": <object>,
      "startsAt": "<rfc3339>",
      "endsAt": "<rfc3339>"
    }
  ]
}
```

### ä½¿ç”¨Golangåˆ›å»ºwebhookæœåŠ¡

é¦–å…ˆæˆ‘ä»¬å°è¯•ä½¿ç”¨Golangåˆ›å»ºç”¨äºæ¥æ”¶webhookå‘Šè­¦é€šçŸ¥çš„æœåŠ¡ã€‚é¦–å…ˆåˆ›å»ºmodelåŒ…ï¼Œç”¨äºæ˜ å°„ALertmanagerå‘é€çš„å‘Šè­¦ä¿¡æ¯ï¼ŒAlertmanagerçš„ä¸€ä¸ªé€šçŸ¥ä¸­æ ¹æ®é…ç½®çš„group_byè§„åˆ™å¯èƒ½ä¼šåŒ…å«å¤šæ¡å‘Šè­¦ä¿¡æ¯Alertã€‚åˆ›å»ºå‘Šè­¦é€šçŸ¥å¯¹åº”çš„ç»“æ„ä½“Notificationã€‚

```
package model

import "time"

type Alert struct {
    Labels      map[string]string `json:"labels"`
    Annotations map[string]string `json:annotations`
    StartsAt    time.Time         `json:"startsAt"`
    EndsAt      time.Time         `json:"endsAt"`
}

type Notification struct {
    Version           string            `json:"version"`
    GroupKey          string            `json:"groupKey"`
    Status            string            `json:"status"`
    Receiver          string            `json:receiver`
    GroupLabels       map[string]string `json:groupLabels`
    CommonLabels      map[string]string `json:commonLabels`
    CommonAnnotations map[string]string `json:commonAnnotations`
    ExternalURL       string            `json:externalURL`
    Alerts            []Alert           `json:alerts`
}
```

è¿™é‡Œä½¿ç”¨gin-gonicæ¡†æ¶åˆ›å»ºç”¨äºæ¥æ”¶Webhooké€šçŸ¥çš„WebæœåŠ¡ã€‚å®šä¹‰è·¯ç”±/webhookæ¥æ”¶æ¥è‡ªAlertmanagerçš„POSTè¯·æ±‚ã€‚

```
package main

import (
    "net/http"

    "github.com/gin-gonic/gin"
    model "github.com/k8stech/alertmanaer-dingtalk-webhook/model"
)

func main() {
    router := gin.Default()
    router.POST("/webhook", func(c *gin.Context) {
        var notification model.Notification

        err := c.BindJSON(&notification)

        if err != nil {
            c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
            return
        }

        c.JSON(http.StatusOK, gin.H{"message": " successful receive alert notification message!"})

    })
    router.Run()
}
```

### ä¸é’‰é’‰é›†æˆ

é’‰é’‰ï¼Œé˜¿é‡Œå·´å·´å‡ºå“ï¼Œä¸“ä¸ºä¸­å›½ä¼ä¸šæ‰“é€ çš„å…è´¹æ™ºèƒ½ç§»åŠ¨åŠå…¬å¹³å°ï¼Œæä¾›äº†å³æ—¶é€šè®¯ä»¥åŠç§»åŠ¨åŠå…¬ç­‰ä¸°å¯Œçš„åŠŸèƒ½ã€‚

[é’‰é’‰ç¾¤æœºå™¨äºº](https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.8M9OKD&treeId=257&articleId=105733&docType=1)æ˜¯é’‰é’‰ç¾¤çš„é«˜çº§æ‰©å±•åŠŸèƒ½ã€‚ç¾¤æœºå™¨äººå¯ä»¥å°†ç¬¬ä¸‰æ–¹æœåŠ¡çš„ä¿¡æ¯èšåˆåˆ°ç¾¤èŠä¸­ï¼Œå®ç°è‡ªåŠ¨åŒ–çš„ä¿¡æ¯åŒæ­¥ã€‚ä¾‹å¦‚ï¼šé€šè¿‡èšåˆGitHubï¼ŒGitLabç­‰æºç ç®¡ç†æœåŠ¡ï¼Œå®ç°æºç æ›´æ–°åŒæ­¥ï¼›é€šè¿‡èšåˆTrelloï¼ŒJIRAç­‰é¡¹ç›®åè°ƒæœåŠ¡ï¼Œå®ç°é¡¹ç›®ä¿¡æ¯åŒæ­¥ã€‚ä¸ä»…å¦‚æ­¤ï¼Œç¾¤æœºå™¨äººæ”¯æŒWebhookåè®®çš„è‡ªå®šä¹‰æ¥å…¥ï¼Œæ”¯æŒæ›´å¤šå¯èƒ½æ€§ã€‚è¿™é‡Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚æœå°†Alertmanagerè¿ç»´æŠ¥è­¦æé†’é€šè¿‡è‡ªå®šä¹‰æœºå™¨äººèšåˆåˆ°é’‰é’‰ç¾¤ã€‚

è¿™é‡Œå°†ç»§ç»­æ‰©å±•webhookæœåŠ¡ï¼Œä»¥æ”¯æŒå°†Alertmanagerçš„å‘Šè­¦é€šçŸ¥è½¬å‘åˆ°é’‰é’‰å¹³å°ã€‚å®Œæ•´çš„ç¤ºä¾‹ä»£ç å¯ä»¥ä»githubä»“åº“[https://github.com/k8stech/alertmanaer-dingtalk-webhook](https://github.com/k8stech/alertmanaer-dingtalk-webhook)ä¸­è·å–ã€‚

##### è‡ªå®šä¹‰webhookç¾¤æœºå™¨äºº

é€šè¿‡é’‰é’‰å®¢æˆ·ç«¯ï¼ˆå¦‚ï¼šæ¡Œé¢æˆ–è€…æ‰‹æœºï¼‰è¿›å…¥åˆ°ç¾¤è®¾ç½®åé€‰æ‹©â€œç¾¤æœºå™¨äººâ€ã€‚å°†æ˜¾ç¤ºå¦‚ä¸‹ç•Œé¢ï¼š

![dingding-group-robot](assets/dingding-group-robot-20230802143832-k9znmk0.png)

é€‰æ‹©â€œè‡ªå®šä¹‰æœºå™¨äººâ€ï¼Œå¹¶ä¸”æŒ‰ç…§æç¤ºå¡«å†™æœºå™¨äººåç§°ï¼Œè·å–æœºå™¨äººwebhookåœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![dingtalk-robot-create-webhook](assets/dingtalk-robot-create-webhook-20230802143842-ofma4eq.png)

webhookæœºå™¨äººåˆ›å»ºæˆåŠŸåï¼Œç”¨æˆ·å°±å¯ä»¥ä½¿ç”¨ä»»ä½•æ–¹å¼å‘è¯¥åœ°å€å‘èµ·HTTP POSTè¯·æ±‚ï¼Œå³å¯å®ç°å‘è¯¥ç¾¤ä¸»å‘é€æ¶ˆæ¯ã€‚ç›®å‰è‡ªå®šä¹‰æœºå™¨äººæ”¯æŒæ–‡æœ¬(text)ï¼Œè¿æ¥(link)ï¼Œmarkdownä¸‰ç§æ¶ˆæ¯ç±»å‹ã€‚

ä¾‹å¦‚ï¼Œå¯ä»¥å‘webhookåœ°å€ä»¥POSTå½¢å¼å‘é€ä»¥ä¸‹

```
{
     "msgtype": "markdown",
     "markdown": {
         "title":"Prometheuså‘Šè­¦ä¿¡æ¯",
         "text": "#### ç›‘æ§æŒ‡æ ‡\n" +
                 "> ç›‘æ§æè¿°ä¿¡æ¯\n\n" +
                 "> ###### å‘Šè­¦æ—¶é—´ \n"
     },
    "at": {
        "atMobiles": [
            "156xxxx8827",
            "189xxxx8325"
        ], 
        "isAtAll": false
    }
 }
```

å¯ä»¥ä½¿ç”¨curléªŒè¯é’‰é’‰webhookæ˜¯å¦èƒ½å¤ŸæˆåŠŸè°ƒç”¨ï¼š

```
$ curl -l -H "Content-type: application/json" -X POST -d '{"msgtype": "markdown","markdown": {"title":"Prometheuså‘Šè­¦ä¿¡æ¯","text": "#### ç›‘æ§æŒ‡æ ‡\n> ç›‘æ§æè¿°ä¿¡æ¯\n\n> ###### å‘Šè­¦æ—¶é—´ \n"},"at": {"isAtAll": false}}' https://oapi.dingtalk.com/robot/send?access_token=xxxx
{"errcode":0,"errmsg":"ok"}
```

è°ƒç”¨æˆåŠŸåï¼Œå¯ä»¥åœ¨é’‰é’‰åº”ç”¨ç¾¤æ¶ˆæ¯ä¸­æ¥æ”¶åˆ°ç±»ä¼¼äºå¦‚ä¸‹é€šçŸ¥æ¶ˆæ¯:

![dingtalk-message-test](assets/dingtalk-message-test-20230802143852-9v1lqur.png)

##### å®šä¹‰è½¬æ¢å™¨å°†å‘Šè­¦é€šçŸ¥è½¬åŒ–ä¸ºDingtalkæ¶ˆæ¯å¯¹è±¡

è¿™é‡Œå®šä¹‰ç»“æ„ä½“DingTalkMarkdownç”¨äºæ˜ å°„Dingtalkçš„æ¶ˆæ¯ä½“ã€‚

```
package model

type At struct {
    AtMobiles []string `json:"atMobiles"`
    IsAtAll   bool     `json:"isAtAll"`
}

type DingTalkMarkdown struct {
    MsgType  string    `json:"msgtype"`
    At       *At       `json:at`
    Markdown *Markdown `json:"markdown"`
}

type Markdown struct {
    Title string `json:"title"`
    Text  string `json:"text"`
}
```

å®šä¹‰è½¬æ¢å™¨å°†Alertmanagerå‘é€çš„å‘Šè­¦é€šçŸ¥è½¬æ¢ä¸ºDingtalkçš„æ¶ˆæ¯ä½“ã€‚

```
package transformer

import (
    "bytes"
    "fmt"

    "github.com/k8stech/alertmanaer-dingtalk-webhook/model"
)

// TransformToMarkdown transform alertmanager notification to dingtalk markdow message
func TransformToMarkdown(notification model.Notification) (markdown *model.DingTalkMarkdown, err error) {

    groupKey := notification.GroupKey
    status := notification.Status

    annotations := notification.CommonAnnotations

    var buffer bytes.Buffer

    buffer.WriteString(fmt.Sprintf("### é€šçŸ¥ç»„%s(å½“å‰çŠ¶æ€:%s) \n", groupKey, status))

    buffer.WriteString(fmt.Sprintf("#### å‘Šè­¦é¡¹:\n"))

    for _, alert := range notification.Alerts {
        annotations := alert.Annotations
        buffer.WriteString(fmt.Sprintf("##### %s\n > %s\n", annotations["summary"], annotations["description"]))
        buffer.WriteString(fmt.Sprintf("\n> å¼€å§‹æ—¶é—´ï¼š%s\n", alert.StartsAt.Format("15:04:05")))
    }

    markdown = &model.DingTalkMarkdown{
        MsgType: "markdown",
        Markdown: &model.Markdown{
            Title: fmt.Sprintf("é€šçŸ¥ç»„ï¼š%s(å½“å‰çŠ¶æ€:%s)", groupKey, status),
            Text:  buffer.String(),
        },
        At: &model.At{
            IsAtAll: false,
        },
    }

    return
}
```

##### åˆ›å»ºDingtalké€šçŸ¥å‘é€åŒ…

notifieråŒ…ä¸­ä½¿ç”¨golangçš„net/httpåŒ…å®ç°ä¸Dingtalkç¾¤æœºå™¨äººçš„äº¤äº’ã€‚Sendæ–¹æ³•åŒ…å«ä¸¤ä¸ªå‚æ•°ï¼šæ¥æ”¶åˆ°çš„å‘Šè­¦é€šçŸ¥ç»“æ„ä½“æŒ‡é’ˆï¼Œä»¥åŠDingtalkç¾¤æœºå™¨äººçš„Webhookåœ°å€ã€‚

é€šè¿‡åŒ…transformer.TransformToMarkdownå°†Alertmanagerå‘Šè­¦é€šçŸ¥ä¸Dingtalkæ¶ˆæ¯è¿›è¡Œæ˜ å°„ã€‚

```
package notifier

import (
    "bytes"
    "encoding/json"
    "fmt"
    "net/http"

    "github.com/k8stech/alertmanaer-dingtalk-webhook/model"
    "github.com/k8stech/alertmanaer-dingtalk-webhook/transformer"
)

func Send(notification model.Notification, dingtalkRobot string) (err error) {

    markdown, err := transformer.TransformToMarkdown(notification)

    if err != nil {
        return
    }

    data, err := json.Marshal(markdown)
    if err != nil {
        return
    }

    req, err := http.NewRequest(
        "POST",
        dingtalkRobot,
        bytes.NewBuffer(data))

    if err != nil {
        return
    }

    req.Header.Set("Content-Type", "application/json")
    client := &http.Client{}
    resp, err := client.Do(req)

    if err != nil {
        return
    }

    defer resp.Body.Close()
    fmt.Println("response Status:", resp.Status)
    fmt.Println("response Headers:", resp.Header)

    return
}
```

##### æ‰©å±•å¯åŠ¨å‡½æ•°

é¦–å…ˆä¸ºç¨‹åºæ·»åŠ å‘½ä»¤è¡Œå‚æ•°æ”¯æŒï¼Œç”¨äºåœ¨å¯åŠ¨æ—¶æ·»åŠ å…¨å±€çš„Dingtalkç¾¤èŠæœºå™¨äººåœ°å€ã€‚

```
package main

import (
  "flag"
  ...
  "github.com/k8stech/alertmanaer-dingtalk-webhook/notifier"
)

var (
    h            bool
    defaultRobot string
)

func init() {
    flag.BoolVar(&h, "h", false, "help")
    flag.StringVar(&defaultRobot, "defaultRobot", "", "global dingtalk robot webhook")
}

func main() {

    flag.Parse()

    if h {
        flag.Usage()
        return
    }

  ...

}
```

åŒæ—¶é€šè¿‡notifieråŒ…çš„Sendæ–¹æ³•å°†å‘Šè­¦é€šçŸ¥å‘é€ç»™Dingtalkç¾¤èŠæœºå™¨äºº

```
func main() {

  ...

  err = notifier.Send(notification, defaultRobot)

  if err != nil {
    c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})

  }

  c.JSON(http.StatusOK, gin.H{"message": "send to dingtalk successful!"})
}
```

##### ä½¿ç”¨Dingtalkæ‰©å±•

è¿è¡Œå¹¶å¯åŠ¨dingtalk webhookæœåŠ¡ä¹‹åï¼Œä¿®æ”¹Alertmanageré…ç½®æ–‡ä»¶, ä¸ºdefault-receiveræ·»åŠ webhooké…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```
receivers:
  - name: default-receiver
    email_configs:
      - to: yunl.zheng@wise2c.com
    webhook_configs:
      - url: http://localhost:8080/webhook
```

é‡å¯AlertmanageræœåŠ¡åï¼Œæ‰‹åŠ¨æ‹‰é«˜è™šæ‹ŸæœºCPUä½¿ç”¨ç‡è§¦å‘å‘Šè­¦æ¡ä»¶ï¼Œæ­¤æ—¶Dingtalkå³å¯æ¥æ”¶åˆ°ç›¸åº”çš„å‘Šè­¦é€šçŸ¥ä¿¡æ¯:

![alertmanager-dingtalk-test-result](assets/alertmanager-dingtalk-test-result-20230802143908-twd1kwi.png)
