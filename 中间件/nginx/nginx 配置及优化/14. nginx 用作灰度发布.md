
**用map+split_clients做真正的灰度发布**

很多人灰度发布就是改`upstream`的`weight`，但这有个问题：同一个用户刷新页面可能一会儿看到新版一会儿看到老版，体验很差。

真正的灰度应该是：一旦某个用户被分到新版本，他就一直看新版本。

```nginx
# 按用户ID的哈希值分流，保证同一用户始终走同一版本
split_clients "${cookie_user_id}" $variant {
    10%    new;
    *      old;
}

map $variant $backend {
    new    new_backend;
    old    old_backend;
}

upstream new_backend {
    server 192.168.1.11:8080;
}

upstream old_backend {
    server 192.168.1.10:8080;
}

server {
    location / {
        proxy_pass http://$backend;
    }
}
```

`split_clients`会对`cookie_user_id`做哈希，同一个`ID`永远落到同一个桶里。这样用户A如果被分到10%的新版本，他刷一百次都是新版本。

我们上线一个大改版的时候就是这么做的，先放1%观察了三天，没问题再放到10%，最后全量。中间发现新版本有个页面白屏，直接把比例改成0%，用户无感知回滚。