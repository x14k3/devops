我们将深入探讨 `/etc/security/limits.conf` 这个重要的配置文件。与 `ulimit` 命令只能影响当前会话及其子进程不同，通过 `limits.conf` 设置的资源限制，可以在用户登录时由系统层面（确切地说，是通过 可插拔认证模块 (Pluggable Authentication Modules, PAM)）加载并应用，从而实现对特定用户、组或所有用户的持久化资源控制。理解并掌握 `limits.conf` 的配置，对于系统管理员、应用开发者以及任何关心系统资源管理和安全的用户都至关重要。

### 3.1 limits.conf文件的位置与作用

`/etc/security/limits.conf` 文件是 Linux 系统中用于设定用户和组资源限制的主要配置文件。它的作用是为通过 PAM 进行身份验证（Authentication）和会话管理（Session Management）的用户设定默认的资源限制值。

**文件位置（File Location）**：  
>`/etc/security/limits.conf` 是标准的配置文件路径。  
现代 Linux 发行版通常还会读取 `/etc/security/limits.d/` 目录下的 `.conf` 文件。这些目录中的文件提供了更灵活和模块化的方式来管理资源限制，避免所有配置都集中在一个大文件中。

**作用原理（Working Principle）**：  

>`limits.conf` 文件本身并不会直接约束进程。它的作用是通过 `pam_limits` 这个 PAM 模块来实现的。  
当用户通过支持 PAM 的服务（例如：`login`、`sshd`、`su`）登录或创建新会话时，PAM 框架会调用相应的服务配置（位于 `/etc/pam.d/` 目录下）。如果这些服务配置中包含了 `pam_limits.so` 模块，那么 `pam_limits` 模块就会被执行。  
`pam_limits` 模块负责读取 `/etc/security/limits.conf` 文件（以及 `/etc/security/limits.d/` 目录下的文件），根据当前用户的身份信息（用户名、所属组等），查找匹配的规则，并将这些规则中定义的资源限制应用到用户的新会话或进程上。  
这些由 `pam_limits` 应用的限制，实际上设定了用户会话的初始软限制（Soft Limit）和硬限制（Hard Limit）。用户在其会话内部可以使用 `ulimit` 命令在这些由 PAM 设定的硬限制范围内调整其软限制。

简单来说，`limits.conf` 文件是存储配置规则的地方，而 `pam_limits` 模块是读取并执行这些规则的引擎，它们协同工作，为用户登录后的会话设置持久化的资源限制。

### 3.2 limits.conf文件格式详解

`/etc/security/limits.conf` 文件（以及 `/etc/security/limits.d/` 中的文件）遵循一种简单的、基于行的格式。每一行通常定义一个资源限制规则，格式如下：
`<domain> <type> <item> <value>`
或者
`<domain> <type> <item> <value> # comment`

让我们逐个字段进行详细解析。

#### 3.2.1 <domain>字段：指定用户或组

`<domain>` 字段指定了该规则应用的范围，即对哪些用户或组生效。这是区分不同用户或组设置不同限制的关键。

① **可能的取值（Possible Values）**：  
**用户名（Username）**：直接指定一个用户名，例如 `john`。规则仅对该用户生效。
```bash
john soft nofile 4096
```

**组名（Group Name）**：指定一个组名，并在前面加上 `@` 符号，例如 `@users`。规则对该组的所有成员生效。
```bash
@developers hard nproc 256
```

**通配符 `*` (Wildcard `*`)**：表示对所有用户生效。通常用于设置全局的默认限制。
```bash
* soft core 0
```

**通配符 `%` (Wildcard `%`)**：不常用，在某些特定 PAM 配置中可能表示对所有组生效，但在 `limits.conf` 的常规用法中，建议使用 `@groupname` 的形式。  
**排除特定用户或组（Excluding Specific Users/Groups）**：可以通过在特定规则之后使用更宽泛的规则来排除。例如，先为所有用户设置一个低限制，再为特定用户设置一个高限制。优先级规则将在第 5 章中详细讨论。

理解 `<domain>` 字段是正确应用资源限制的第一步。你可以为单个用户设置特别严格或宽松的限制，也可以为整个组设置统一的限制，或者为系统中所有非 root 用户设置一个基准限制。

#### 3.2.2 <type>字段：设置软限制或硬限制

`<type>` 字段指定了该规则设置的是软限制（Soft Limit）、硬限制（Hard Limit）还是两者都设置。

① **软限制（Soft Limit）**：  
>关键字：`soft`  
软限制是当前实际生效的限制。  
用户或进程可以将其软限制提高到不超过对应的硬限制。  
通常，软限制用于发出警告或作为资源使用的指导性上限，当达到软限制时，系统可能会记录日志或发出通知。

② **硬限制（Hard Limit）**：  
>关键字：`hard`  
硬限制是资源使用的绝对上限。  
非特权用户（Non-privileged Users）不能提高其硬限制，只能降低。  
root 用户不受硬限制约束（尽管可以在 `limits.conf` 中为其设置，但通常可以通过其他方式绕过）。  
硬限制通常用于强制执行资源策略，防止单个用户或进程耗尽系统资源。

③ **同时设置软硬限制（Setting Both）**：  
>关键字：`-`  
如果 `<type>` 字段设置为 `-`，则表示同时将软限制和硬限制设置为 `<value>` 字段指定的值。这是最常见的设置方式，因为它确保了软限制不会超过硬限制，并且一次性设定了实际生效的上限和绝对上限。

理解软限制和硬限制的区别非常重要。软限制更灵活，用户可以在一定范围内自行调整；硬限制是强制性的，由管理员设定，普通用户无法突破。通常的实践是为某个资源设置一个合理的硬限制，然后根据需要设置一个较低的软限制，允许用户或应用程序在必要时临时提升软限制（不超过硬限制）。

#### 3.2.3 <item>字段：指定资源类型

`<item>` 字段指定了要限制的具体资源类型。这些资源类型与 `ulimit` 命令中的选项是对应的。

**常用资源类型详解（Common Resource Types）**：  
`core`：限制核心转储文件（Core Dump File）的最大大小（以 KB 为单位）。设置为 `0` 可以禁止生成核心转储文件。  
`data`：限制进程数据段（Data Segment）的最大大小（以 KB 为单位）。  
`fsize`：限制进程创建的文件的最大大小（以 KB 为单位）。  
`memlock`：限制进程可以锁定到内存中的最大内存量（以 KB 为单位）。对于需要使用内存锁定（Memory Locking）的应用程序（如实时应用、数据库），此项很重要。  
`nofile`：限制进程可以打开的最大文件描述符（File Descriptors）数量。这可能是最常用的限制项之一，尤其对于高并发服务如 Web 服务器、数据库等。  
`nproc`：限制用户可以启动的最大进程（Processes）数量。用于防止单个用户通过启动大量进程（如 fork bomb）耗尽系统资源。  
`rss`：限制进程常驻集大小（Resident Set Size），即进程在物理内存中占用的最大内存量（以 KB 为单位）。在某些系统上可能不起作用或行为不同。  
`stack`：限制进程栈（Stack）的最大大小（以 KB 为单位）。  
`cpu`：限制进程的最大 CPU 使用时间（以分钟为单位）。进程达到此限制时会收到信号并通常终止。  
`as`：限制进程地址空间（Address Space）的最大大小（以 KB 为单位），包括代码段、数据段、堆、栈等。基本上是虚拟内存的限制。  
`locks`：限制用户可以持有的文件锁（File Locks）的最大数量。  
`sigpending`：限制用户可以拥有的待处理信号（Pending Signals）的最大数量。  
`msgqueue`：限制用户可以使用的 POSIX 消息队列（Message Queue）的总大小（以 Bytes 为单位）。  
`nice`：限制用户可以设置的最大 nice 值（Minimum Nice Value）。nice 值越小，进程优先级越高。这是一个负向限制，值越小（优先级越高）表示限制越严格。例如，`nice 0` 意味着用户不能将 nice 值设置为负数。  
`rtprio`：限制用户可以设置的最大实时优先级（Maximum Real-time Priority）。  
`maxlogins`：限制用户可以同时登录的最大会话（Login Sessions）数量。注意：这个限制项由 `pam_limits` 实现，但行为可能因 PAM 配置和服务类型而异。在一些发行版或配置下，它限制的是通过特定服务（如 `login`、`sshd`）的并发登录数。

这些 `<item>` 字段提供了对进程和用户资源使用的精细控制。选择合适的限制项取决于你想要解决的具体问题或实施的策略。

#### 3.2.4 <value>字段：设置限制值

`<value>` 字段指定了前面 `<item>` 字段所指定资源的具体限制数值。

① **数值（Numerical Value）**：  
>大多数资源限制项的 `<value>` 是一个非负整数，表示资源的上限。单位取决于 `<item>` 类型，例如 `core`、`data`、`fsize`、`memlock`、`rss`、`stack`、`as` 的单位是 KB，`cpu` 的单位是分钟，`nofile`、`nproc`、`locks`、`sigpending`、`maxlogins`、`nice`、`rtprio` 的单位是数量。

② **无限制（Unlimited）**：  
>关键字：`unlimited`  
如果 `<value>` 字段设置为 `unlimited`，则表示对该资源不设限制。

举例：
- `* hard nofile 65536`：对所有用户，将打开文件数的硬限制设置为 65536。
- `@students soft nproc 50`：对 `students` 组的所有成员，将进程数的软限制设置为 50。
- `mysql hard memlock unlimited`：对 `mysql` 用户，不对内存锁定大小设硬限制。

正确理解并设定 `<value>` 对于避免资源耗尽和保障服务运行至关重要。过低的限制可能导致合法应用崩溃，而过高的限制则无法达到限制资源的目的。

### 3.3 实际配置示例

现在，让我们通过一些具体的例子来展示如何在 `limits.conf` 中设置资源限制。这些示例覆盖了一些常见的系统管理场景。

**示例 1：限制普通用户的进程数** 🛡️  
为了防止普通用户意外或恶意地启动过多进程（例如 fork bomb），我们可以限制其最大进程数。假设我们希望所有非特权用户最多只能创建 100 个进程。

```bash
# 设置所有用户的进程数软限制为 100，硬限制为 128
* soft nproc 100
* hard nproc 128
# 注意：root 用户通常不受此限制
# 如果需要为特定用户设置不同的限制，可以在后面添加更具体的规则
# 例如，允许用户 'developer' 创建更多进程
# developer soft nproc 200
# developer hard nproc 256
```
**解释**：第一行设置软限制，当用户达到 100 个进程时可能会收到警告。第二行设置硬限制，用户最多只能创建 128 个进程。如果用户达到 128 个进程，尝试创建新进程的操作（如 `fork` 或 `exec`）将失败。

 **示例 2：增加数据库服务用户的文件描述符上限** 💾  
数据库服务器（如 MySQL、PostgreSQL）在高并发连接下会打开大量文件（包括网络套接字也表现为文件描述符）。默认的文件描述符限制（通常是 1024）可能不足，导致连接失败或性能下降。假设数据库服务运行在 `mysql` 用户下，我们需要将其文件描述符上限提高到 65536。

```bash
# 为 mysql 用户设置打开文件数的软限制和硬限制都为 65536
mysql - nofile 65536
# 解释：使用 '-' 类型表示同时设置软硬限制
# 这确保了 mysql 用户默认就可以打开这么多文件描述符
```

**解释**：此规则专门针对 `mysql` 用户。使用 `-` 类型一次性将软硬限制都设为 65536。这意味着 `mysql` 用户及其启动的进程（如 `mysqld`）将能够打开多达 65536 个文件描述符。请注意，这还受系统级别的最大文件描述符数（由内核参数 `fs.file-max` 控制）的影响。

**示例 3：限制特定组的内存使用** 🧠  
如果有一个开发团队 (`developers` 组) 经常运行一些可能消耗大量内存的测试程序，为了防止他们影响整个系统的稳定性，可以限制其总虚拟内存使用量。

```bash
# 为 developers 组设置虚拟内存（地址空间）的软限制为 1GB，硬限制为 1.5GB
# 1GB = 1024 * 1024 KB = 1048576 KB
# 1.5GB = 1.5 * 1024 * 1024 KB = 1572864 KB
@developers soft as 1048576
@developers hard as 1572864
# 注意：as 限制的是地址空间，不是物理内存。
# 物理内存相关的限制通常更复杂，或者通过 cgroups 进行更精确的控制。
```

**解释**：使用 `@developers` 指定组。`as` 限制的是虚拟内存。这里的限制是针对组内每个用户的。当一个用户的所有进程总虚拟内存使用量超过软限制时，可能会收到警告；超过硬限制时，新的内存分配请求将失败。

**示例 4：禁止所有用户生成核心转储文件** 🙅‍♂️  
核心转储文件包含了进程崩溃时的内存镜像，对于调试很有用，但同时也可能占用大量磁盘空间，并包含敏感信息。在生产环境中，出于安全或空间考虑，常常会禁止普通用户生成核心转储文件。

```bash
# 禁止所有用户生成核心转储文件
* soft core 0
* hard core 0
# 注意：root 用户通常不受此限制
```

**解释**：将 `core` 的软硬限制都设置为 `0`。这意味着当进程崩溃时，不会生成核心转储文件。

**应用配置的注意事项（Configuration Application Notes）**：  
修改 `limits.conf` 文件后，通常需要用户**重新登录（Re-login）**其会话，新的限制才会通过 `pam_limits` 生效。  
对于作为系统服务运行的进程，可能需要**重启相应的服务**，以便服务进程在其新的受限环境中启动。服务启动脚本通常会通过 `su` 或其他方式切换到特定的服务用户，这时也会触发 PAM 认证和限制应用过程。  
不是所有的服务都会调用 `pam_limits`。你需要检查 `/etc/pam.d/` 目录下对应服务的配置文件（如 `sshd`、`login`、`sudo` 等），确保其中包含 `session required pam_limits.so` 或类似的行。我们将在下一章详细讨论 PAM 配置。

通过这些示例，希望您能对 `limits.conf` 的配置方式有一个直观的了解。在实际应用中，请根据您的具体需求仔细选择 `<domain>`、`<type>`、`<item>` 和 `<value>`。

### 3.4 limits.d目录的使用

在现代 Linux 发行版中，`/etc/security/limits.conf` 文件通常只包含一些默认规则和注释。推荐的做法是将自定义的资源限制配置放在 `/etc/security/limits.d/` 目录下，以 `.conf` 结尾的文件中。这种模块化的方式有几个显著的优点：

① **模块化和组织性（Modularity and Organization）**：  
你可以为不同的应用程序或用户群体创建单独的配置文件，例如 `mysql.conf`、`apache.conf`、`developers.conf`。这使得配置更易于管理和理解。  
例如，为 MySQL 服务用户 `mysql` 设置文件描述符限制，可以创建 `/etc/security/limits.d/mysql.conf` 文件。

② **避免冲突和简化升级（Avoiding Conflicts and Simplifying Upgrades）**：  
当系统升级时，`/etc/security/limits.conf` 文件可能会被替换或更新。将自定义配置放在 `limits.d` 目录下可以避免你的修改在升级时丢失。  
不同的软件包或服务安装时，也可以将自己的资源限制需求放置到 `limits.d` 目录下的文件中，减少手动合并配置的麻烦。

③ **易于启用和禁用（Easy Enable/Disable）**：  
要临时禁用某个特定的资源限制配置，只需将其文件移动出 `limits.d` 目录或更改其后缀名（例如改为 `.disabled`）。

`/etc/security/limits.d/` 目录中的文件通常是按照字母顺序读取的。这意味着文件的命名可能会影响规则的优先级，尽管在大多数情况下，更具体的规则（如针对特定用户的规则）优先级高于更通用的规则（如针对所有用户的规则），无论文件顺序如何。关于优先级更详细的讨论，请参考第 5 章。

**如何使用 `limits.d` 目录（How to Use `limits.d` Directory）**：

① **创建配置文件**：  
使用文本编辑器在 `/etc/security/limits.d/` 目录下创建一个新的文件，文件名通常以 `.conf` 结尾，例如 `sudo nano /etc/security/limits.d/myapp.conf`。

```bash
sudo vi /etc/security/limits.d/myapp.conf
```

② **添加限制规则**：  
在新创建的文件中，按照 `<domain> <type> <item> <value>` 的格式添加你的资源限制规则。例如：

```bash
# /etc/security/limits.d/myapp.conf
# 为运行 myapp 的用户 'myappuser' 增加文件描述符限制
myappuser soft nofile 8192
myappuser hard nofile 16384
# 限制 'myappuser' 的进程数
myappuser soft nproc 200
myappuser hard nproc 256
```

③ **保存文件**：  
保存并关闭文件。

④ **应用配置**：  
如前所述，用户需要**重新登录**会话，或者**重启**相关的服务进程，以使新的限制生效。

使用 `limits.d` 目录是管理复杂系统上资源限制的推荐方法。它提高了配置的清晰度、可维护性和可升级性，是现代 Linux 系统管理的重要实践。