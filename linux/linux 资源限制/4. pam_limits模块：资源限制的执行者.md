可插拔认证模块(Pluggable Authentication Modules, PAM)框架，特别是其中的`pam_limits`模块。我们将解析`pam_limits`模块如何作为连接用户认证（或会话启动）与系统资源限制的桥梁，将`/etc/security/limits.conf`文件中定义的规则应用于用户登录会话，从而确保系统资源被合理地分配和使用。理解`pam_limits`的工作原理对于全面掌握Linux资源限制机制至关重要。

### 4.1 Linux PAM框架概述

在深入了解`pam_limits`模块之前，有必要先对其所处的环境——Linux可插拔认证模块(PAM)框架——有一个基本的认识。PAM是一个强大的、灵活的用户认证和授权框架，旨在将服务（如登录、SSH）的认证过程与实际的认证机制（如密码文件、LDAP、Kerberos等）解耦。这意味着系统管理员可以在不修改服务程序本身的情况下，灵活地配置和更改系统的认证策略。

PAM框架的核心思想是模块化。它定义了一组API，服务程序调用这些API来执行认证、账户管理、会话管理和密码管理等任务。具体的认证逻辑则由一系列可插拔的模块来实现。这些模块根据配置文件（通常位于`/etc/pam.d/`目录下）的定义，被组织成一个或多个**堆栈(stack)**。

PAM定义了四种主要的管理组（management group）：

- **认证管理(Authentication Management)**：负责验证用户的身份，例如通过密码或密钥。它确定用户“是谁”。  
- **账户管理(Account Management)**：检查账户的有效性，例如账户是否过期、是否允许在当前时间或终端登录等。它确定用户“是否允许”进行某些操作。  
- **会话管理(Session Management)**：负责在用户成功认证之前和之后执行一些操作，例如记录登录日志、挂载用户主目录、设置环境参数或**设置资源限制**。它负责启动和结束用户会话。  
- **密码管理(Password Management)**：负责处理用户密码的更改。

每个服务程序（如`login`、`sshd`、`su`、`sudo`等）通常在`/etc/pam.d/`目录下有一个对应的配置文件（例如`/etc/pam.d/login`、`/etc/pam.d/sshd`）。这些配置文件中定义了该服务在执行认证、账户、会话和密码管理时需要调用的PAM模块及其顺序。每一行通常代表一个模块的配置，包括模块类型、控制标志和模块路径及参数。

```bash
# 示例：/etc/pam.d/sshd 中的部分内容
auth      required  pam_unix.so
account   required  pam_nologin.so
password  required  pam_unix.so use_authtok shadow
session   optional  pam_keyinit.so force revoke
session   required  pam_loginuid.so
session   optional  pam_selinux.so open
session   required  pam_limits.so   # 这一行就是我们关注的！
session   required  pam_unix.so
session   optional  pam_systemd.so
session   optional  pam_lastlog.so open
```

在这个示例中，我们可以看到`sshd`服务调用了不同管理组的多个PAM模块。`pam_limits.so`模块通常被配置在`session`管理组中，这正是它能够对用户会话应用资源限制的关键所在。

### 4.2 pam_limits模块的功能与原理

`pam_limits`是一个PAM模块，它的主要功能是在用户会话建立时，根据预定义的规则来设置该会话及其派生进程的资源限制。它本身并不定义资源限制的规则，而是充当一个“执行者”的角色，读取其他地方定义的规则，并将这些规则通过系统调用`setrlimit(2)`应用到当前进程（通常是用户shell或启动的应用进程）。

`pam_limits`模块**主要**依赖于`/etc/security/limits.conf`文件及其对应的`/etc/security/limits.d/`目录下的文件来获取资源限制规则。当配置了`pam_limits`模块的服务启动用户会话时（例如用户通过`ssh`登录），PAM框架会执行`session`堆栈中的模块。当轮到`pam_limits`模块执行时，它会：

① 读取`/etc/security/limits.conf`文件以及`/etc/security/limits.d/`目录下的所有`.conf`文件。  
② 根据当前登录用户的用户名、所属组以及发起服务的域（在`limits.conf`的`<domain>`字段中指定），查找所有匹配的资源限制规则。  
③ 根据匹配规则的优先级（后面会详细介绍），确定最终应用于该用户的各种资源限制（软限制和硬限制）。  
④ 使用`setrlimit(2)`系统调用，将确定的软限制和硬限制应用到发起会话的进程。

**核心原理**：`pam_limits`模块通过读取`/etc/security/limits.conf`等配置文件，在用户**登录成功后、执行用户shell或其他启动程序之前**，修改当前进程（通常是登录shell）的资源限制。由于子进程默认会继承父进程的资源限制，因此通过这种方式，`pam_limits`可以有效地为整个用户会话设置资源上限。

值得注意的是，`pam_limits`是在**会话建立时**应用限制，这意味着它只影响通过PAM认证并启动的会话。对于已经运行的进程，或者不经过PAM认证的方式启动的进程（例如系统启动时由init/systemd启动的服务进程，除非其启动脚本或systemd service unit文件明确设置了限制），`pam_limits`是无效的。对于已经运行的进程，可以使用`prlimit`命令来修改其资源限制（需要相应权限）。

### 4.3 pam_limits模块的配置

`pam_limits`模块的配置主要涉及修改PAM服务配置文件，使其在`session`堆栈中包含`pam_limits.so`模块。这些配置文件通常位于`/etc/pam.d/`目录下。

#### 4.3.1 常见的PAM服务文件（如login, sshd, su）

以下是一些常见的、需要配置`pam_limits`模块的服务文件：

① `/etc/pam.d/login`：控制通过文本控制台登录的认证和会话过程。  
② `/etc/pam.d/sshd`：控制通过SSH协议远程登录的认证和会话过程。  
③ `/etc/pam.d/su`：控制用户使用`su`命令切换用户身份的过程。  
④ `/etc/pam.d/sudo`：控制用户使用`sudo`命令以其他用户身份执行命令的过程（尽管`sudo`更多依赖自身的配置`/etc/sudoers`来限制权限，但在某些配置下，PAM也会介入）。  
⑤ `/etc/pam.d/systemd-user`：如果系统使用systemd作为初始化系统，用户通过某些方式登录（如图形界面登录管理器或`ssh`），可能会启动`systemd --user`进程来管理用户会话。这个文件的配置会影响到用户登录后启动的所有进程的资源限制。

在这些文件中，你需要找到或添加一行，通常在`session`区域，类似这样：

```bash
session    required     pam_limits.so
```

或者，在一些发行版中，可能会通过`include`指令来包含一个通用的配置，例如：

```bash
session    include      system-auth
```

然后，在被包含的文件（如`/etc/pam.d/system-auth`）中，会有`pam_limits.so`的配置行。这种方式有助于集中管理PAM配置。

建议在修改PAM配置文件之前先备份，错误的配置可能导致用户无法登录！

#### 4.3.2 required, sufficient, optional等控制标志

PAM模块的每一行配置都包含一个**控制标志(control flag)**，它决定了该模块在PAM堆栈中的执行结果如何影响整个认证或会话过程的成败。理解这些标志对于正确配置`pam_limits`至关重要。常见的控制标志有：

① `required`：如果该模块成功，则继续处理堆栈中的下一个模块；如果失败，则记录错误，但继续处理堆栈中的其余模块。只有堆栈中的所有`required`模块都成功，该管理组的整体结果才可能成功。如果任何`required`模块失败，无论后续模块结果如何，最终该管理组的结果都将失败。  
② `requisite`：如果该模块成功，则继续处理下一个模块；如果失败，则立即终止该管理组的处理过程，并返回失败结果。这是一种“快速失败”机制。  
③ `sufficient`：如果该模块成功，并且之前没有遇到任何`required`模块的失败，则立即终止该管理组的处理过程，并返回成功结果，忽略堆栈中后续的模块。如果该模块失败，则当作`optional`处理。  
④ `optional`：该模块的成功或失败对该管理组的整体结果通常没有决定性影响。除非该管理组是空的或者只包含`optional`模块，并且至少有一个`optional`模块成功，否则其结果不会影响整体认证/会话结果。  
⑤ `include`：不是一个模块，而是引用另一个PAM配置文件的内容。

对于`pam_limits`模块，它通常用于设置用户会话的环境参数（资源限制），即使设置资源限制失败（例如，`/etc/security/limits.conf`文件不存在或有错误），通常也不应该阻止用户登录。因此，`pam_limits`模块常被配置在`session`堆栈中，使用`required`或`optional`标志。

- 使用`session required pam_limits.so`：表示设置资源限制是会话建立过程中“必须尝试”的一步。如果`pam_limits`模块因为自身错误（而非规则拒绝）而执行失败（例如，无法读取配置文件），整个会话建立过程可能会失败。但如果它成功读取并应用了规则（无论这些规则是否限制了用户），这一步就被认为是成功的。
- 使用`session optional pam_limits.so`：表示设置资源限制是会话建立过程中一个“可选的”步骤。即使`pam_limits`模块执行失败，通常也不会影响用户正常登录。这提供了更高的容错性。

在大多数现代Linux发行版中，`/etc/pam.d`文件中的默认配置通常会使用`session required pam_limits.so`，因为它确保了资源限制总是会被尝试应用，这对于系统稳定性和安全是很重要的。

### 4.4 pam_limits与limits.conf的协同工作

现在，让我们详细描述用户登录时，`pam_limits`模块如何与`limits.conf`文件协同工作来应用资源限制。假设用户`testuser`通过SSH登录系统。

这是一个简化的流程描述：

① 用户在SSH客户端输入用户名和密码。  
② `sshd`服务收到连接请求，并调用PAM框架开始认证过程。  
③ PAM框架根据`/etc/pam.d/sshd`文件中的配置，顺序执行`auth`堆栈中的模块，验证用户名和密码。  
④ 如果`auth`堆栈验证成功，PAM框架继续执行`account`堆栈中的模块，检查用户账户是否有效。  
⑤ 如果`account`堆栈检查成功，PAM框架进入`session`阶段，准备建立用户会话。  
⑥ PAM框架开始顺序执行`/etc/pam.d/sshd`文件中`session`堆栈中的模块。  
⑦ 当执行到配置了`pam_limits.so`的那一行时，PAM框架调用`pam_limits`模块。  
⑧ `pam_limits`模块开始工作：  
ⓐ 它首先读取`/etc/security/limits.conf`文件以及`/etc/security/limits.d/`目录下所有以`.conf`结尾的文件。  
ⓑ 对于当前登录的用户`testuser`，`pam_limits`模块会解析这些文件中的每一行，查找`<domain>`字段匹配`testuser`、`@testgroup`（如果`testuser`属于`testgroup`）、`*`或`%`的规则。  
ⓒ 它会处理所有匹配的规则，并根据内置的优先级规则（通常是：特定用户 > 特定组 > 通配符* > 通配符%）为每种资源类型（如`nofile`, `nproc`等）确定最终的软限制和硬限制。关于优先级，更具体的规则是：首先，查找精确匹配用户名的规则；如果找到，则应用这些规则，并可能根据后续更通用的规则进行调整。然后，查找匹配用户所属组的规则；如果找到，应用这些规则。最后，应用通配符`*`（所有用户）和`%`（所有组）的规则。同一类型规则（如都是硬限制）遇到多条时，通常取最严格的那个值，但软/硬限制之间，或者不同domain类型之间的交互规则可能更复杂，man手册是最终权威。  
ⓓ 对于确定的每一种资源类型的软限制和硬限制值，`pam_limits`模块使用`setrlimit(2)`系统调用将其应用到当前的`sshd`进程派生的用于启动用户shell的进程。  
⑨ `pam_limits`模块执行完毕，根据其控制标志（如`required`或`optional`）向PAM框架报告结果。  
⑩ PAM框架继续执行`session`堆栈中的其他模块（如设置环境变量、记录日志等）。  
⑪ `session`堆栈所有模块执行成功后，PAM框架认为会话建立成功。  
⑫ `sshd`服务继续启动`testuser`的登录shell（如`/bin/bash`）。  
⑬ 这个登录shell进程由于是之前设置了资源限制的进程的子进程，它将继承父进程的资源限制。  
⑭ 用户在shell中执行的任何命令或启动的任何应用程序，都将继承shell的资源限制。

**流程图概念描述（非实际绘制流程图）**：

```bash
[用户SSH登录请求]
      ↓
[sshd服务调用PAM]
      ↓
[PAM框架执行 auth 堆栈] → 身份验证
      ↓ (成功)
[PAM框架执行 account 堆栈] → 账户检查
      ↓ (成功)
[PAM框架执行 session 堆栈]
      ↓
[执行 pam_limits.so 模块]
      ↓
[读取 /etc/security/limits.conf 及 limits.d/*.conf]
      ↓
[根据用户/组/通配符匹配规则并确定最终限制]
      ↓
[使用 setrlimit(2) 应用限制到当前进程]
      ↓
[pam_limits 返回结果给PAM框架]
      ↓
[PAM框架执行 session 堆栈中其余模块]
      ↓ (session成功)
[sshd启动用户登录Shell]
      ↓
[Shell继承资源限制]
      ↓
[用户在Shell中操作，受限于继承的资源限制]

```

通过这个过程，`/etc/security/limits.conf`中为特定用户或组设置的持久化资源限制，就在用户登录时被`pam_limits`模块动态地应用到了他们的会话中，从而实现了对系统资源的有效控制。