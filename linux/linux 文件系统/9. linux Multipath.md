
**æ ¸å¿ƒä»·å€¼ï¼š**Â é€šè¿‡å†—ä½™ç‰©ç†è·¯å¾„è¿æ¥å­˜å‚¨è®¾å¤‡ï¼Œæå‡å­˜å‚¨è®¿é—®çš„**å¯ç”¨æ€§ã€å¯é æ€§å’Œæ€§èƒ½**ã€‚

---

### **ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ**

1. **ç‰©ç†è·¯å¾„ (Physical Path)**
    
    - æœåŠ¡å™¨HBAå¡ â†’ å…‰çº¤äº¤æ¢æœº â†’ å­˜å‚¨æ§åˆ¶å™¨ç«¯å£çš„å®Œæ•´é“¾è·¯
        
    - æ¯è·¯å¾„åœ¨OSä¸­è¡¨ç°ä¸ºç‹¬ç«‹å—è®¾å¤‡ï¼ˆå¦‚Â `/dev/sdb`,Â `/dev/sdc`ï¼‰
        
2. **è®¾å¤‡æ˜ å°„å™¨ (Device Mapper)**
    
    - Linuxå†…æ ¸æ¡†æ¶ï¼Œç”¨äºåˆ›å»ºè™šæ‹Ÿå—è®¾å¤‡
        
    - Multipathä¾èµ–æ­¤æ¡†æ¶å®ç°è·¯å¾„èšåˆ
        
3. **å¤šè·¯å¾„è®¾å¤‡ (Multipath Device)**
    
    - èšåˆå¤šæ¡è·¯å¾„å½¢æˆçš„è™šæ‹Ÿè®¾å¤‡ï¼ˆå¦‚Â `/dev/mapper/mpatha`ï¼‰
        
    - åº”ç”¨å±‚ç›´æ¥è®¿é—®æ­¤è®¾å¤‡ï¼Œæ— éœ€æ„ŸçŸ¥åº•å±‚è·¯å¾„
        
4. **è·¯å¾„çŠ¶æ€**
    
    - **Active/Optimized (A/O)**ï¼šæ´»è·ƒè·¯å¾„ï¼ˆæ”¯æŒI/Oï¼‰
        
    - **Active/Non-Optimized (A/N)**ï¼šéä¼˜é€‰è·¯å¾„ï¼ˆä»å¯ç”¨ï¼‰
        
    - **Failed (F)**ï¼šæ•…éšœè·¯å¾„ï¼ˆä¸å¯ç”¨ï¼‰
        
    - **Standby (S)**ï¼šå¤‡ç”¨è·¯å¾„ï¼ˆå¾…æ¿€æ´»ï¼‰
        
5. **è·¯å¾„é€‰æ‹©ç­–ç•¥**
    
    - `service-time`ï¼šåŠ¨æ€é€‰æ‹©å»¶è¿Ÿæœ€ä½è·¯å¾„ï¼ˆæ¨èï¼‰
        
    - `round-robin`ï¼šè½®è¯¢å„è·¯å¾„ï¼ˆå‡è¡¡è´Ÿè½½ï¼‰
        
    - `queue-length`ï¼šé€‰æ‹©é˜Ÿåˆ—æœ€çŸ­è·¯å¾„
        
    - `failover`ï¼šä¸»å¤‡åˆ‡æ¢ï¼ˆä»…ç”¨ä¸»è·¯å¾„ï¼‰
        

---

### **äºŒã€é…ç½®æ­¥éª¤ï¼ˆä»¥ä¸»æµå­˜å‚¨ä¸ºä¾‹ï¼‰**

#### 1. å®‰è£…è½¯ä»¶åŒ…

```bash
# RHEL/CentOS
yum install device-mapper-multipath

# Ubuntu/Debian
apt install multipath-tools
```



#### 2. ç”Ÿæˆåˆå§‹é…ç½®

```bash
mpathconf --enable --with_multipathd y
```



#### 3. ç¼–è¾‘é…ç½®æ–‡ä»¶Â `/etc/multipath.conf`

```conf
defaults {
    user_friendly_names yes    # ä½¿ç”¨å‹å¥½åˆ«åï¼ˆå¦‚ mpathaï¼‰
    path_grouping_policy multibus  # è·¯å¾„ç»„ç­–ç•¥
    path_selector "service-time 0" # I/Oè°ƒåº¦ç­–ç•¥
    failback immediate         # ä¸»è·¯å¾„æ¢å¤åç«‹å³åˆ‡æ¢
    no_path_retry fail        # æ‰€æœ‰è·¯å¾„å¤±æ•ˆåçš„æ“ä½œ
}

# å­˜å‚¨è®¾å¤‡ç‰¹å®šé…ç½®ï¼ˆç¤ºä¾‹ï¼šDell EMC PowerStoreï¼‰
devices {
    device {
        vendor "PURE"         # å‚å•†æ ‡è¯†ï¼ˆé€šè¿‡`multipath -v3`è·å–ï¼‰
        product "FlashArray"   # äº§å“å‹å·
        path_grouping_policy group_by_prio  # æŒ‰ä¼˜å…ˆçº§åˆ†ç»„
        path_checker tur       # ä½¿ç”¨Test Unit Readyå‘½ä»¤æ£€æµ‹è·¯å¾„
        hardware_handler "1 alua" # ALUAå¤„ç†å™¨
        prio alua              # åŸºäºALUAä¼˜å…ˆçº§
        fast_io_fail_tmo 10    # å¿«é€Ÿå¤±è´¥è¶…æ—¶(ç§’)
    }
}
```



#### 4. å¯åŠ¨æœåŠ¡

```bash
systemctl enable --now multipathd

```


#### 5. é‡è½½é…ç½®

```bash
multipath -r   # åŠ¨æ€é‡è½½é…ç½®
multipath -F && multipath -v2  # å¼ºåˆ¶åˆ·æ–°è®¾å¤‡
```


---

### **ä¸‰ã€å…³é”®ç»´æŠ¤å‘½ä»¤**

| å‘½ä»¤                      | ç”¨é€”                 | ç¤ºä¾‹è¾“å‡ºæ‘˜è¦                                                                                                                                                                                                                 |
| ----------------------- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `multipath -ll`         | æŸ¥çœ‹å¤šè·¯å¾„æ‹“æ‰‘            | `mpatha (3600a09803830417939244a4a7044a684) dm-0 PURE,FlashArray`  <br>`size=100G features='0' hwhandler='1 alua' ...`  <br>`\_ 4:0:0:1 sdb 8:16 active ready running`  <br>`\_ 5:0:0:1 sdc 8:32 active ready running` |
| `multipath -v3`         | è°ƒè¯•æ¨¡å¼ï¼ˆæ˜¾ç¤ºè®¾å¤‡è¯¦æƒ…ï¼‰       | è¾“å‡ºåŒ…æ‹¬è®¾å¤‡vendor/product IDã€è·¯å¾„æ£€æµ‹è¿‡ç¨‹ç­‰                                                                                                                                                                                        |
| `multipath -f <device>` | åˆ é™¤æŒ‡å®šå¤šè·¯å¾„è®¾å¤‡          | `multipath -f mpatha`                                                                                                                                                                                                  |
| `dmsetup table`         | æŸ¥çœ‹DMè®¾å¤‡æ˜ å°„è¡¨          | `mpatha: 0 209715200 multipath 0 0 1 1 service-time ...`                                                                                                                                                               |
| `ls /dev/mapper/`       | åˆ—å‡ºå¤šè·¯å¾„è®¾å¤‡            | `mpatha mpatha-part1 mpathb`                                                                                                                                                                                           |
| `rescan-scsi-bus.sh -r` | åŠ¨æ€æ‰«æSCSIè®¾å¤‡ï¼ˆæ·»åŠ /åˆ é™¤åï¼‰ | éœ€å®‰è£…`sg3-utils`                                                                                                                                                                                                         |

---

### **å››ã€å¸¸è§æ•…éšœæ’æŸ¥**

#### **åœºæ™¯1ï¼šè·¯å¾„å¤±æ•ˆï¼ˆ`multipath -ll`æ˜¾ç¤º`failed`ï¼‰**

```bash
# æ£€æŸ¥SCSIå±‚é”™è¯¯
dmesg | grep -i "sdb"  # æ›¿æ¢ä¸ºå®é™…è®¾å¤‡å

# æ‰‹åŠ¨æ¢å¤è·¯å¾„
echo 1 > /sys/block/sdb/device/rescan  # é‡æ–°æ‰«æè®¾å¤‡
multipathd -k"resize map mpatha"       # é€šçŸ¥multipathdåˆ·æ–°
```



#### **åœºæ™¯2ï¼šæ‰€æœ‰è·¯å¾„å¤±æ•ˆ**

```bash
# æ£€æŸ¥å­˜å‚¨è¿æ¥çŠ¶æ€
systool -c fc_host -v  # æŸ¥çœ‹å…‰çº¤HBAçŠ¶æ€

# ç´§æ€¥æ¢å¤ï¼ˆè°¨æ…æ“ä½œï¼ï¼‰
multipathd -k"fail path sdb"  # æ ‡è®°è·¯å¾„å¤±æ•ˆè§¦å‘åˆ‡æ¢
```


---

### **äº”ã€é«˜çº§ä¼˜åŒ–å»ºè®®**

1. **é˜Ÿåˆ—æ·±åº¦è°ƒæ•´**Â (æå‡IOPS)
```bash
# åœ¨/etc/multipath.confä¸­
device {
    vendor "PURE"
    product "FlashArray"
    nr_requests 128     # å¢åŠ é˜Ÿåˆ—æ·±åº¦
}

```


2. **ALUAä¼˜å…ˆçº§ä¼˜åŒ–**Â (ç¡®ä¿ä½¿ç”¨æœ€ä¼˜è·¯å¾„)
```bash
  
# æŸ¥çœ‹è·¯å¾„ä¼˜å…ˆçº§ multipathd -k"show paths" | grep prio
```

3. **å¤šè·¯å¾„ç½‘ç»œç»‘å®š**Â (é¿å…å•äº¤æ¢æœºæ•…éšœ)
	- å°†ä¸åŒHBAå¡è¿æ¥åˆ°ç‹¬ç«‹å…‰çº¤äº¤æ¢æœº
---

### **å…­ã€å…³é”®é…ç½®æ–‡ä»¶**

1. **`/etc/multipath.conf`**ï¼šä¸»é…ç½®æ–‡ä»¶
    
2. **`/etc/multipath/bindings`**ï¼šè®¾å¤‡åˆ«åç»‘å®š
    
3. **`/etc/multipath/wwids`**ï¼šç³»ç»Ÿå·²çŸ¥WWIDåˆ—è¡¨
    

> ğŸ“ŒÂ **æœ€ä½³å®è·µæç¤ºï¼š**
> 
> - ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…é€šè¿‡Â `wwid`Â è€ŒéÂ `user_friendly_names`Â ç¡®ä¿è®¾å¤‡åæŒä¹…æ€§
>     
> - æ›´æ–°å­˜å‚¨å¾®ç åé‡æ–°éªŒè¯å¤šè·¯å¾„é…ç½®
>     
> - ä½¿ç”¨Â `storcli`Â /Â `MegaCLI`Â ç­‰å·¥å…·ç›‘æ§HBAå¡çŠ¶æ€
>     

æŒæ¡å¤šè·¯å¾„æŠ€æœ¯å¯æ˜¾è‘—æå‡å­˜å‚¨æ¶æ„çš„**å¼¹æ€§**ä¸**æ€§èƒ½**ã€‚å»ºè®®åœ¨éç”Ÿäº§ç¯å¢ƒå……åˆ†æµ‹è¯•åå†éƒ¨ç½²ï¼