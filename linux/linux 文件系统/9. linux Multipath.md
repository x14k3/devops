
# å‰è¨€

é€šå¸¸ Linux ä¸»æœºæŒ‚è½½å­˜å‚¨ç›˜æ—¶ï¼Œæ¯æ¬¡é‡å¯åå¯¹åº”çš„Â `/dev/sd*`Â éƒ½ä¼šå˜ï¼Œè€Œä¸”ä¸å¥½è¾¨è¯†ï¼
è¿™æ—¶å¯ä»¥é€šè¿‡ multipath å¤šè·¯å¾„æ¥ç»‘å®šç£ç›˜ï¼

# å®‰è£… multipath

```bash
yum install -y device-mapper-multipath
# ç”Ÿæˆé…ç½®æ–‡ä»¶
mpathconf --enable --with_multipathd y
mpathconf --enable --find_multipaths y --with_module y

# --enableï¼šç”¨äºå¯ç”¨multipathå®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ã€‚
# --find_multipaths yï¼šç”¨äºè®¾ç½®multipath.confé…ç½®æ–‡ä»¶ä¸­çš„find_multipathså‚æ•°ä¸ºyesã€‚  
	# å¦‚æœè®¾ç½®ä¸ºyesï¼Œé‚£ä¹ˆå¤šè·¯å¾„å®ˆæŠ¤è¿›ç¨‹å°†åªå¯¹åœ¨multipath.confä¸­æ˜ç¡®åˆ—å‡ºçš„è®¾å¤‡ã€æˆ–è€…å·²ç»æœ‰å¤šæ¡è·¯å¾„çš„è®¾å¤‡è¿›è¡Œå¤šè·¯å¾„å¤„ç†ã€‚è¿™å¯ä»¥é¿å…å¯¹åªæœ‰å•è·¯å¾„çš„è®¾å¤‡è¿›è¡Œå¤šè·¯å¾„å¤„ç†ï¼Œä»è€Œå‡å°‘ä¸å¿…è¦çš„å¤„ç†ã€‚
# --with_module yï¼šç”¨äºæŒ‡å®šæ˜¯å¦åœ¨multipath.confä¸­åŠ è½½é»˜è®¤çš„æ¨¡å—ï¼ˆå³ç¡¬ä»¶ç‰¹å®šçš„å¤šè·¯å¾„æ¨¡å—ï¼‰ã€‚è®¾ç½®ä¸ºyè¡¨ç¤ºåŠ è½½è¿™äº›æ¨¡å—ã€‚
```

æ‰§è¡Œä»¥ä¸Šå‘½ä»¤åï¼Œmultipath å·²ç»æˆåŠŸå®‰è£…å¹¶ä¸”åˆå§‹åŒ–ï¼

# é…ç½® multipath

é»˜è®¤å°†Â `sda`Â ç³»ç»Ÿç›˜æ’é™¤ï¼Œé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```bash
cat <<EOF >/etc/multipath.conf
defaults {  
  find_multipaths yes
  user_friendly_names yes  
  path_grouping_policy multibus  
  failback immediate  
  no_path_retry fail  
}
 
blacklist {
  devnode "^sda"
}
EOF

  
```

æ‰§è¡Œä»¥ä¸Šå‘½ä»¤ï¼Œå°†ç»‘å®šé™¤ç³»ç»Ÿå®‰è£…ç›˜ï¼ˆ/dev/sdaï¼‰ä¹‹å¤–æ‰€æœ‰çš„ç›˜ï¼

æ³¨æ„ï¼šå¦‚æœéœ€è¦é…ç½®å¯¹åº”çš„ç›˜çš„åç§°ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š UUID å’Œåˆ«åçš„æ–¹å¼ï¼š

```bash
cat <<EOF >/etc/multipath.conf
defaults {  
  find_multipaths yes
  user_friendly_names yes  
  path_grouping_policy multibus  
  failback immediate  
  no_path_retry fail  
}
 
blacklist {
  devnode "^sda"
}

multipaths {
  multipath {
  wwid è·å–å¯¹åº”ç£ç›˜çš„UUID
  alias éœ€è¦è‡ªå®šä¹‰çš„åˆ«å
  }
}
EOF

  
```

**ä¸Šé¢ğŸ‘†ğŸ»å‘½ä»¤ä¸­çš„ UUID è·å–æ–¹å¼å¯ä»¥å‚è€ƒï¼š
```bash
# Linux 6
scsi_id -g -u /dev/sda
# Linux 7/8
/usr/lib/udev/scsi_id -g -u /dev/sda

# å¯¹äºè¾ƒæ—§ç³»ç»Ÿï¼ˆå¦‚RHEL/CentOS 5ï¼‰ï¼Œå¯èƒ½éœ€è¦Â `scsi_id --whitelist /dev/sd*`ã€‚
# å¯¹äºä¸€äº›æ–°å‹é©±åŠ¨æˆ–è®¾å¤‡ï¼Œ`-g`ï¼ˆguess WWIDï¼‰æˆ–Â `-p`Â (SCSI VPD Page 83) é€‰é¡¹å¯èƒ½æ›´æœ‰æ•ˆã€‚
```
# é‡è½½ multipath

é…ç½®å®Œ multipath ä¹‹åï¼Œå¹¶ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼

```bash
multipath -F
multipath -v2
multipath -ll
```

è‡³æ­¤ï¼Œmultipath å³é…ç½®å®Œæˆï¼


# multipath å¸¸ç”¨å‘½ä»¤

```bash
# æ˜¾ç¤ºå’ŒæŸ¥è¯¢
multipath -ll                     # æ˜¾ç¤ºæ‰€æœ‰å¤šè·¯å¾„è®¾å¤‡è¯¦ç»†ä¿¡æ¯
multipath -l                      # æ˜¾ç¤ºå¤šè·¯å¾„è®¾å¤‡åˆ—è¡¨ï¼ˆç®€åŒ–æ ¼å¼ï¼‰
multipath -s                      # æ˜¾ç¤ºå¤šè·¯å¾„è®¾å¤‡çš„çŠ¶æ€ç»Ÿè®¡
multipath -q                      # æ˜¾ç¤ºå½“å‰é…ç½®çš„è·¯å¾„
multipath -t                      # æ˜¾ç¤ºæ‹“æ‰‘ä¿¡æ¯
multipath -p                      # æ˜¾ç¤ºè·¯å¾„çŠ¶æ€


# è®¾å¤‡æ“ä½œ
multipath -v2                     # é‡æ–°æ‰«æå¹¶æ˜¾ç¤ºè®¾å¤‡ï¼ˆ-v è¯¦ç»†è¾“å‡ºï¼Œ2ä¸ºçº§åˆ«ï¼‰
multipath -F                      # åˆ·æ–°æ‰€æœ‰å¤šè·¯å¾„è®¾å¤‡
multipath -f <è®¾å¤‡å>              # åˆ é™¤æŒ‡å®šå¤šè·¯å¾„è®¾å¤‡
multipath -r                      # é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶å¹¶é‡æ–°æ‰«æ
multipath -R                      # å¼ºåˆ¶é‡æ–°åŠ è½½é…ç½®

# è°ƒè¯•å’Œæ•…éšœæ’æŸ¥
multipath -d                      # è°ƒè¯•æ¨¡å¼ï¼Œä¸åˆ›å»ºè®¾å¤‡
multipath -v0                     # ä¸è¾“å‡ºä¿¡æ¯
multipath -v1                     # è¾“å‡ºåŸºæœ¬ä¿¡æ¯
multipath -v2                     # è¾“å‡ºè¯¦ç»†ä¿¡æ¯
multipath -v3                     # è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼ˆæœ€è¯¦ç»†ï¼‰
multipath -T                      # æµ‹è¯•æ¨¡å¼ï¼Œæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æ“ä½œä½†ä¸æ‰§è¡Œ
multipath -B                      # æ˜¾ç¤ºè®¾å¤‡ç»‘å®šä¿¡æ¯

# é…ç½®ç›¸å…³
multipath -C                      # æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
multipath -P                      # æ˜¾ç¤ºå½“å‰é…ç½®
multipath -c                      # æ˜¾ç¤ºé…ç½®è·¯å¾„

```

# `/etc/multipath.conf`Â é…ç½®æ–‡ä»¶è¯¦è§£

1. **defaults éƒ¨åˆ†**ï¼šè®¾ç½®å…¨å±€é»˜è®¤å€¼ã€‚
2. **blacklist éƒ¨åˆ†**ï¼šæŒ‡å®šä¸è¿›è¡Œå¤šè·¯å¾„ç®¡ç†çš„è®¾å¤‡ã€‚
3. **blacklist_exceptions éƒ¨åˆ†**ï¼šåœ¨blacklistä¸­ä¾‹å¤–å¤„ç†çš„è®¾å¤‡ã€‚
4. **multipaths éƒ¨åˆ†**ï¼šé’ˆå¯¹ç‰¹å®šå¤šè·¯å¾„è®¾å¤‡çš„ä¸ªæ€§åŒ–è®¾ç½®ã€‚
5. **devices éƒ¨åˆ†**ï¼šé’ˆå¯¹ç‰¹å®šå­˜å‚¨è®¾å¤‡ï¼ˆé€šè¿‡vendorå’Œproductè¯†åˆ«ï¼‰çš„è®¾ç½®ã€‚

## é…ç½®æ–‡ä»¶ç»“æ„

```bash
defaults {
    # å…¨å±€é»˜è®¤è®¾ç½®
}
blacklist {
    # é»‘åå• - æ’é™¤çš„è®¾å¤‡
}
blacklist_exceptions {
    # é»‘åå•ä¾‹å¤– - ç‰¹åˆ«åŒ…å«çš„è®¾å¤‡
}
multipaths {
    # é’ˆå¯¹ç‰¹å®šå¤šè·¯å¾„è®¾å¤‡çš„è®¾ç½®
}
devices {
    # é’ˆå¯¹ç‰¹å®šå­˜å‚¨è®¾å¤‡çš„è®¾ç½®
}
```

## 1.Â **defaults éƒ¨åˆ† - å…¨å±€é»˜è®¤è®¾ç½®**

```bash
defaults {
    user_friendly_names yes          # ä½¿ç”¨å‹å¥½åç§°ï¼ˆå¦‚mpathaï¼‰ä»£æ›¿WWID
    find_multipaths yes              # è‡ªåŠ¨å‘ç°å¤šè·¯å¾„è®¾å¤‡
    polling_interval 5               # è·¯å¾„æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    path_grouping_policy multibus    # è·¯å¾„åˆ†ç»„ç­–ç•¥
    path_selector "round-robin 0"    # è·¯å¾„é€‰æ‹©ç®—æ³•
    failback manual                  # æ•…éšœæ¢å¤ç­–ç•¥
    rr_min_io 1000                   # è½®è¯¢å‰æœ€å°IOæ•°
    rr_weight priorities             # è½®è¯¢æƒé‡
    no_path_retry fail               # æ— è·¯å¾„æ—¶é‡è¯•ç­–ç•¥
    queue_without_daemon no          # æ— å®ˆæŠ¤è¿›ç¨‹æ—¶æ˜¯å¦æ’é˜Ÿ
    flush_on_last_del yes            # åˆ é™¤æœ€åè·¯å¾„æ—¶åˆ·æ–°
    max_sectors_kb 512               # æœ€å¤§æ‰‡åŒºå¤§å°
    path_checker tur                 # è·¯å¾„æ£€æŸ¥æ–¹æ³•
    uid_attribute ID_SERIAL          # ç”¨æˆ·æ ‡è¯†å±æ€§
    prio const                       # è·¯å¾„ä¼˜å…ˆçº§ç®—æ³•
    prio_args none                   # ä¼˜å…ˆçº§å‚æ•°
    features "0"                     # è®¾å¤‡ç‰¹æ€§
    hardware_handler "0"             # ç¡¬ä»¶å¤„ç†å™¨
    reservation_key no               # ä¿ç•™å¯†é’¥
    delay_watch_checks no            # å»¶è¿Ÿç›‘è§†æ£€æŸ¥
    delay_wait_checks no             # å»¶è¿Ÿç­‰å¾…æ£€æŸ¥
    san_path_err_threshold no        # SANè·¯å¾„é”™è¯¯é˜ˆå€¼
    san_path_err_forget_rate no      # SANè·¯å¾„é”™è¯¯é—å¿˜ç‡
    san_path_err_recovery_time no    # SANè·¯å¾„é”™è¯¯æ¢å¤æ—¶é—´
    marginal_path_double_failed_time no   # è¾¹ç¼˜è·¯å¾„åŒå¤±è´¥æ—¶é—´
    marginal_path_err_sample_time no      # è¾¹ç¼˜è·¯å¾„é”™è¯¯é‡‡æ ·æ—¶é—´
    marginal_path_err_rate_threshold no   # è¾¹ç¼˜è·¯å¾„é”™è¯¯ç‡é˜ˆå€¼
    marginal_path_err_recheck_gap_time no # è¾¹ç¼˜è·¯å¾„é”™è¯¯é‡æ£€æŸ¥é—´éš”
    fast_io_fail_tmo 5               # å¿«é€ŸIOå¤±è´¥è¶…æ—¶
    dev_loss_tmo 30                  # è®¾å¤‡ä¸¢å¤±è¶…æ—¶
    all_tg_pt yes                    # æ‰€æœ‰ç›®æ ‡ç«¯å£
    retain_attached_hw_handler yes   # ä¿ç•™é™„åŠ çš„ç¡¬ä»¶å¤„ç†å™¨
    detect_prio yes                  # æ£€æµ‹ä¼˜å…ˆçº§
    detect_checker yes               # æ£€æµ‹æ£€æŸ¥å™¨
    hw_str_match yes                 # ç¡¬ä»¶å­—ç¬¦ä¸²åŒ¹é…
    verbosity 2                      # æ—¥å¿—è¯¦ç»†çº§åˆ«
}
```

### å…³é”®å‚æ•°è¯¦è§£ï¼š

**è·¯å¾„åˆ†ç»„ç­–ç•¥**ï¼š

```bash
path_grouping_policy multibus           # æ‰€æœ‰è·¯å¾„åœ¨ä¸€ä¸ªç»„ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
path_grouping_policy failover           # æ¯ä¸ªä¼˜å…ˆçº§ç»„ä¸€ä¸ªè·¯å¾„ï¼ˆä¸»å¤‡ï¼‰
path_grouping_policy group_by_serial    # æŒ‰åºåˆ—å·åˆ†ç»„
path_grouping_policy group_by_prio.     # æŒ‰ä¼˜å…ˆçº§åˆ†ç»„
path_grouping_policy group_by_node_name # æŒ‰èŠ‚ç‚¹ååˆ†ç»„
```

**è·¯å¾„é€‰æ‹©ç®—æ³•**ï¼š

```bash
path_selector "round-robin 0"     # è½®è¯¢ï¼ˆé»˜è®¤ï¼‰
path_selector "queue-length 0"    # é˜Ÿåˆ—é•¿åº¦æœ€çŸ­ä¼˜å…ˆ
path_selector "service-time 0"    # æœåŠ¡æ—¶é—´æœ€çŸ­ä¼˜å…ˆ
```

**æ•…éšœæ¢å¤ç­–ç•¥**ï¼š

```bash

failback immediate                # ç«‹å³æ•…éšœæ¢å¤
failback manual                   # æ‰‹åŠ¨æ•…éšœæ¢å¤ï¼ˆé»˜è®¤ï¼‰
failback followover               # è·Ÿéšæ•…éšœæ¢å¤
```

## 2.Â **blacklist éƒ¨åˆ† - è®¾å¤‡é»‘åå•**

```bash
blacklist {
    wwid 26353900f02796769         # æ’é™¤ç‰¹å®šWWIDè®¾å¤‡
    devnode "^hd[a-z]"             # æ’é™¤æœ¬åœ°ç¡¬ç›˜
    devnode "^sd[a-z]$"            # æ’é™¤å•ä¸ªSCSIç£ç›˜
    devnode "^cciss.*"             # æ’é™¤HP SmartArray
    device {
        vendor "ATA"               # æ’é™¤ATAè®¾å¤‡
        product "*"                # æ‰€æœ‰äº§å“
    }
    device {
        vendor "IBM"               # æ’é™¤IBMè®¾å¤‡
        product "S/390.*"          # ç‰¹å®šäº§å“
    }
    property "(SCSI_IDENT_.*|ID_WWN)"    # æ’é™¤å±æ€§åŒ¹é…è®¾å¤‡
}

```

## 3.Â **blacklist_exceptions éƒ¨åˆ† - é»‘åå•ä¾‹å¤–**

```bash
blacklist_exceptions {
    wwid 3600508b4000156d70001200000b0000  # ç‰¹åˆ«åŒ…å«çš„WWID
    devnode "^sd[a-z][1-9]+"               # åŒ…å«å¤šåˆ†åŒºè®¾å¤‡
    device {
        vendor "EMC"                       # åŒ…å«EMCè®¾å¤‡
        product "SYMMETRIX.*"              # ç‰¹å®šäº§å“
    }
}

```
## 4.Â **multipaths éƒ¨åˆ† - ç‰¹å®šå¤šè·¯å¾„è®¾å¤‡è®¾ç½®**

```bash
multipaths {
    multipath {
        wwid 3600508b4000156d70001200000b0000  # è®¾å¤‡WWID
        alias oracle_data                      # è‡ªå®šä¹‰åˆ«å
        path_grouping_policy multibus          # è¦†ç›–å…¨å±€è®¾ç½®
        path_selector "round-robin 0"
        failback manual
        rr_weight priorities
        no_path_retry 5                       # æ— è·¯å¾„æ—¶é‡è¯•5æ¬¡
        prio rdac                             # ä½¿ç”¨rdacä¼˜å…ˆçº§
        hardware_handler "1 rdac"             # ç¡¬ä»¶å¤„ç†å™¨
        features "2 pg_init_retries 50"       # ç‰¹æ€§è®¾ç½®
        path_checker tur                      # è·¯å¾„æ£€æŸ¥å™¨
    }
    
    multipath {
        wwid 3600144f028f88a0000005037a95d0001
        alias db_archive
        path_grouping_policy group_by_prio
        prio alua                              # ALUAä¼˜å…ˆçº§
        failback followover
        rr_min_io 100
    }
}
```

## 5.Â **devices éƒ¨åˆ† - ç‰¹å®šå­˜å‚¨è®¾å¤‡è®¾ç½®**

```bash
devices {
    device {
        vendor "NETAPP"                      # å‚å•†
        product "LUN.*"                      # äº§å“æ¨¡å¼
        path_grouping_policy group_by_prio   # åˆ†ç»„ç­–ç•¥
        path_selector "round-robin 0"        # è·¯å¾„é€‰æ‹©
        prio "ontap"                         # ä¼˜å…ˆçº§ç®—æ³•
        hardware_handler "1 alua"            # ç¡¬ä»¶å¤„ç†å™¨
        failback immediate                   # æ•…éšœæ¢å¤
        features "2 pg_init_retries 50 queue_if_no_path"  # ç‰¹æ€§
        path_checker tur                     # è·¯å¾„æ£€æŸ¥
        no_path_retry 30                     # æ— è·¯å¾„é‡è¯•
        dev_loss_tmo infinity                # è®¾å¤‡ä¸¢å¤±è¶…æ—¶æ— é™
    }
    
    device {
        vendor "EMC"
        product "SYMMETRIX"
        path_grouping_policy group_by_prio
        getuid_callout "/sbin/scsi_id -g -u -s /block/%n"  # è·å–UID
        prio emc                             # EMCä¼˜å…ˆçº§ç®—æ³•
        hardware_handler "1 emc"             # EMCç¡¬ä»¶å¤„ç†å™¨
        failback immediate
        no_path_retry queue                  # æ— è·¯å¾„æ—¶æ’é˜Ÿ
    }
    
    device {
        vendor "HITACHI"
        product ".*"
        path_grouping_policy group_by_prio
        path_selector "round-robin 0"
        prio hds                             # æ—¥ç«‹ä¼˜å…ˆçº§
        hardware_handler "1 hds"             # æ—¥ç«‹ç¡¬ä»¶å¤„ç†å™¨
        failback immediate
        features "2 pg_init_retries 50"
    }
    
    device {
        vendor "HP"
        product ".*"
        path_grouping_policy group_by_prio
        path_selector "round-robin 0"
        prio hp_sw                           # HPä¼˜å…ˆçº§
        hardware_handler "1 hp_sw"           # HPç¡¬ä»¶å¤„ç†å™¨
        failback immediate
    }
    
    device {
        vendor "DELL"
        product ".*"
        path_grouping_policy group_by_prio
        path_selector "round-robin 0"
        prio alua                            # ALUAä¼˜å…ˆçº§
        hardware_handler "1 alua"            # ALUAç¡¬ä»¶å¤„ç†å™¨
        failback immediate
    }
}
```

## å®Œæ•´é…ç½®ç¤ºä¾‹

```bash
defaults {
    user_friendly_names yes
    find_multipaths yes
    polling_interval 5
    path_grouping_policy multibus
    path_selector "round-robin 0"
    failback manual
    rr_min_io 1000
    no_path_retry fail
    queue_without_daemon no
}

blacklist {
    devnode "^sd[a-z]$"
    devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
    devnode "^hd[a-z]"
    devnode "^cciss.*"
}

blacklist_exceptions {
    wwid 3600508b4000156d70001200000b0000
}

multipaths {
    multipath {
        wwid 3600508b4000156d70001200000b0000
        alias db_data_volume
        path_grouping_policy group_by_prio
        prio alua
        failback immediate
        no_path_retry 5
    }
}

devices {
    device {
        vendor "NETAPP"
        product "LUN.*"
        path_grouping_policy group_by_prio
        prio "ontap"
        hardware_handler "1 alua"
        failback immediate
        no_path_retry queue
    }
}

```
## é…ç½®éªŒè¯å’Œé‡è½½

```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
multipath -t

# æµ‹è¯•é…ç½®ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
multipath -T

# é‡æ–°åŠ è½½é…ç½®
systemctl reload multipathd
# æˆ–
multipathd -k"reconfigure"

# æŸ¥çœ‹å½“å‰é…ç½®
multipath -P
```


## å¸¸ç”¨è®¾å¤‡ç±»å‹é…ç½®

### NetApp è®¾å¤‡ï¼š

```bash
device {
    vendor "NETAPP"
    product "LUN.*"
    prio "ontap"
    hardware_handler "1 alua"
    path_grouping_policy group_by_prio
    failback immediate
    path_checker tur
    no_path_retry queue
}
```

### EMC VNX/Symmetrixï¼š

```bash
device {
    vendor "EMC"
    product "SYMMETRIX"
    prio emc
    hardware_handler "1 emc"
    path_grouping_policy group_by_prio
    failback immediate
    no_path_retry queue
}
```

### HP 3PARï¼š

```bash
device {
    vendor "3PARdata"
    product "VV"
    prio "3par"
    hardware_handler "1 alua"
    path_grouping_policy group_by_prio
    failback immediate
}
```

### IBM SVC/DSï¼š

```bash
device {
    vendor "IBM"
    product "2145"
    prio alua
    hardware_handler "1 alua"
    path_grouping_policy group_by_prio
    failback immediate
}
```


è¿™ä¸ªé…ç½®æ–‡ä»¶éå¸¸çµæ´»ï¼Œå¯ä»¥æ ¹æ®å…·ä½“çš„å­˜å‚¨è®¾å¤‡å’Œä¸šåŠ¡éœ€æ±‚è¿›è¡Œå®šåˆ¶ã€‚