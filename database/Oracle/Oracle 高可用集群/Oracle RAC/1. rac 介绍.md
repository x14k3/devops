#oracle 

**核心思想：** RAC 的核心在于让多个数据库实例（运行在不同服务器节点上）同时访问和管理**同一个**物理数据库（存储在共享存储上）。这提供了高可用性（一个节点故障，其他节点接管）、可伸缩性（通过添加节点提升处理能力）和负载均衡。

## RAC 关键组件

1. **共享存储 (Shared Storage):**
    
    - **作用：** 这是 RAC 的基础。所有数据库文件（数据文件、控制文件、在线重做日志文件、参数文件（SPFILE）等）必须存储在**所有集群节点都能同时访问**的存储设备上。
        
    - **技术：** 通常使用 SAN (Storage Area Network)、NAS (Network Attached Storage) 或 NFS (Network File System)，并配合集群文件系统或 Oracle ASM（首选）。
        
    - **要求：** 必须支持并发读写访问。
        
2. **专用互连网络 (Private Interconnect / Cluster Interconnect):**
    
    - **作用：** 这是节点之间进行高速、低延迟通信的专用网络。用于传输关键的集群协调信息：
        
        - **缓存融合 (Cache Fusion) 流量：** 这是 RAC 的核心机制。当一个节点需要访问的数据块在另一个节点的内存缓存（Buffer Cache）中时，数据块会通过互连网络直接传输，避免了昂贵的磁盘 I/O。
            
        - **集群心跳 (Heartbeat):** 节点间持续发送小消息以检测彼此的存活状态。
            
        - **全局锁管理 (Global Enqueue Service - GES):** 协调跨节点的资源锁定。
            
        - **全局缓存服务 (Global Cache Service - GCS):** 管理数据块在集群各节点 Buffer Cache 中的位置和状态。
            
    - **要求：** 高带宽（至少 10GbE，推荐更快）、低延迟、高可靠性。通常使用冗余的 InfiniBand 或专用高速以太网卡。
        
3. **公共网络 (Public Network):**
    
    - **作用：** 供客户端应用程序连接数据库服务，以及供管理员管理集群节点。
        
    - **技术：** 标准的以太网连接。
        
4. **集群软件 (Cluster Software) - 这就是 Grid Infrastructure (GI)!**
    
    - **作用：** GI 是 Oracle RAC 的**基石和操作平台**。它提供了集群管理、存储管理、高可用性框架和必要的服务，使多个独立的服务器能够像一个单一、逻辑的系统一样协同工作。**没有 GI，就没有 RAC。**
        
    - **核心组件 (GI 内部):**
        
        - **Oracle Clusterware (CRS - Cluster Ready Services):**
            
            - **集群注册表 (OCR - Oracle Cluster Registry):** 存储在共享磁盘上的关键文件，包含集群配置信息（如集群节点列表、数据库实例信息、服务信息、资源依赖关系等）。必须高度可用（通常配置镜像）。
                
            - **表决磁盘 (Voting Disks):** 存储在共享磁盘上的文件（通常奇数个，如 3 个），用于解决“脑裂”问题。节点通过向表决磁盘写入心跳来证明自己存活。在节点间网络连接中断时，拥有多数表决磁盘访问权的节点组可以继续运行，另一组会被驱逐重启。
                
            - **守护进程 (Daemons):**
                
                - `crsd`: 管理集群资源（数据库、实例、监听器、服务、VIP 等）的生命周期（启动、停止、监控、故障转移）。它读取 OCR 中的配置。
                    
                - `ocssd`: 管理集群成员关系和节点监控。处理节点加入/离开事件，维护心跳（通过互连和表决磁盘）。
                    
                - `diskmon`: 监控 ASM 磁盘和表决磁盘的 I/O 隔离性。
                    
                - `mdnsd` / `gpnpd`: 用于 Grid Plug and Play，简化集群配置发现和管理。
                    
                - `ohasd`: Oracle High Availability Services Daemon，是 GI 12c 及以后版本的根守护进程，负责启动和管理其他关键集群守护进程（`cssd`, `crsd` 等）。它基于 `/etc/inittab`或 `systemd` 启动。
                    
        - **Oracle Automatic Storage Management (ASM):**
            
            - **作用：** **强烈推荐**作为 RAC 的共享存储管理器。它提供卷管理和集群文件系统的功能。
                
            - **优势：**
                
                - **专为 RAC 设计：** 原生支持多节点并发访问共享存储。
                    
                - **条带化和镜像：** 提供高性能和冗余（通过磁盘组配置）。
                    
                - **简化管理：** 使用磁盘组管理磁盘，自动负载均衡，在线添加/移除磁盘。
                    
                - **集群文件系统：** 提供集群感知的文件系统（ACFS - ASM Cluster File System），用于存储 Oracle 主目录、诊断文件等。
                    
            - **关键概念：**
                
                - **ASM 实例：** 在每个集群节点上运行一个轻量级的 ASM 实例，管理该节点对 ASM 磁盘组的访问。ASM 实例本身也由 GI 管理。
                    
                - **磁盘组 (Disk Groups):** 物理磁盘的逻辑分组，是 ASM 管理的基本单位。数据库文件存储在磁盘组中。
                    
                - **ASMCMD:** 命令行工具管理 ASM。
                    
                - **ASMLib (可选)：** Linux 上的可选内核模块，用于简化 ASM 磁盘发现和管理（现在 Oracle 更推荐使用 ASM Filter Driver (AFD)）。
                    
5. **Oracle 数据库实例 (Oracle Database Instances):**
    
    - **作用：** 每个集群节点上运行一个标准的 Oracle 数据库实例（有自己的 SGA、后台进程等）。
        
    - **关键点：**
        
        - 所有实例都访问**同一个**物理数据库文件（位于共享存储/ASM 中）。
            
        - 实例之间通过**互连网络**和**全局服务 (GCS/GES)** 紧密协作，实现缓存融合和资源协调。
            
        - 每个实例有自己的 `INSTANCE_NUMBER` 和 `INSTANCE_NAME`。
            
        - 数据库参数文件 (`SPFILE`) 必须位于共享存储上，所有实例使用同一个。
            
6. **监听器 (Oracle Net Listeners):**
    
    - **作用：** 接受客户端连接请求并将其路由到可用的数据库实例。
        
    - **RAC 特性：**
        
        - **SCAN 监听器 (Single Client Access Name):** GI 12c 及以后版本的核心特性。客户端使用一个单一的域名（SCAN）连接到集群，而不是单个节点的主机名。DNS 会将 SCAN 解析为 1-3 个 SCAN VIP（虚拟 IP）。SCAN 监听器在这些 SCAN VIP 上运行（通常由 GI 自动在多个节点上均衡部署），负责将连接请求负载均衡到集群中合适的实例监听器上。
            
        - **节点监听器：** 在每个节点上运行的传统监听器，绑定到节点的 **Virtual IP (VIP)** 和物理 IP 上。它接收来自 SCAN 监听器或直接来自客户端的连接请求（如果使用节点 VIP），并将连接交给该节点上的数据库实例。
            
        - **负载均衡和故障转移：** 监听器（特别是 SCAN 监听器）与集群服务集成，实现连接的负载均衡（根据服务配置）和故障转移（如果一个实例宕机，连接会被路由到其他实例）。
            
7. **虚拟 IP 地址 (Virtual IP - VIP):**
    
    - **作用：** 由 GI 管理的关键网络资源。
        
    - **每个节点一个 VIP：** 该 IP 与节点的物理 IP 不同，并配置在同一个网卡上（或绑定接口上）。
        
    - **故障转移核心：** 如果某个节点宕机，GI 会将该节点的 VIP **漂移 (Failover)** 到集群中的另一个存活节点上。此时：
        
        - 尝试连接故障节点 VIP 的客户端会**立即**被重定向到接管 VIP 的节点（避免了 TCP 超时等待）。
            
        - 客户端使用 SCAN 或节点 VIP 连接时，监听器会感知实例状态，将连接导向可用实例。
            
    - **高可用性保障：** VIP 是实现客户端透明故障转移的关键机制。
        
8. **集群服务 (Cluster Services):**
    
    - **作用：** 由 GI 管理的逻辑实体，代表应用程序或工作负载（如数据库服务）。
        
    - **关键特性：**
        
        - **定义：** 在创建数据库时或之后创建。服务有唯一名称。
            
        - **与实例关联：** 服务可以配置为在特定的一个或多个实例上运行（首选实例、可用实例）。
            
        - **负载均衡：** 客户端连接请求可以通过服务配置（`SERVER=POOL`）在运行该服务的实例之间进行负载均衡（连接时负载均衡 - TAF 基础）。
            
        - **高可用性：** 如果一个运行服务的实例失败，GI 可以将该服务**透明地故障转移 (TAF - Transparent Application Failover)** 到配置的其他可用实例上（需要客户端配置支持 TAF）。连接可能中断也可能不中断（取决于 TAF 类型和操作）。
            
        - **管理：** 使用 `srvctl` 命令管理服务（启动、停止、重定位、状态查看）。
            

## Grid Infrastructure (GI) 的核心作用总结

Grid Infrastructure 是 Oracle RAC 得以运行的**基础平台和引擎**。它集成了之前独立的 Oracle Clusterware 和 Oracle ASM，提供了一个统一的管理框架，主要实现以下功能：

1. **集群管理：**
    
    - 节点成员管理（加入、离开、驱逐）。
        
    - 节点状态监控（心跳检测）。
        
    - 防止脑裂（通过表决磁盘）。
        
    - 维护集群配置信息（OCR）。
        
2. **资源管理：**
    
    - 定义、监控和管理集群资源（数据库实例、监听器、ASM 实例、服务、VIP、磁盘组、应用程序等）。
        
    - 提供资源的启动、停止、检查、故障转移能力。
        
    - 管理资源之间的依赖关系（例如，数据库实例依赖监听器和 VIP）。
        
3. **高可用性框架：**
    
    - 提供快速故障检测（秒级）。
        
    - 自动化故障恢复（VIP 漂移、服务故障转移、实例重启）。
        
    - 确保关键资源（如数据库）在节点故障后仍能快速可用。
        
4. **存储管理 (通过 ASM):**
    
    - 提供集群感知的、高性能、高可用的共享存储管理。
        
    - 简化存储配置、扩展和管理。
        
    - 为数据库文件提供条带化、镜像等特性。
        
5. **网络管理：**
    
    - 管理虚拟 IP (VIP)，实现客户端连接的透明故障转移。
        
    - 部署和管理 SCAN 监听器，简化客户端配置并提供连接负载均衡入口点。
        
6. **服务管理：**
    
    - 提供创建和管理集群服务的能力。
        
    - 将服务与数据库实例关联，实现基于服务的负载均衡和故障转移。
        

**简单来说：** 想象 Grid Infrastructure 是运行在物理服务器集群之上的一个“集群操作系统”。它抽象了底层的硬件和网络复杂性，为 Oracle RAC 数据库以及其他应用（如 Oracle Restart）提供了运行所需的基础设施服务（集群协调、存储、网络、高可用性）。没有 GI 来管理节点、心跳、VIP、服务、存储（ASM）和资源故障转移，多个独立的 Oracle 实例就无法协同工作访问同一个数据库并对外呈现为一个高可用的整体。

因此，在部署 Oracle RAC 时，**首先必须在所有集群节点上安装和配置 Grid Infrastructure**，然后才能在其上创建和运行 RAC 数据库。

GI提供了哪些命令来维护rac

嗯，用户现在问的是Grid Infrastructure提供了哪些命令来维护RAC。看来用户已经了解了RAC的基本架构和GI的作用，现在想深入实际操作层面。用户可能是DBA或者系统管理员，正在负责维护Oracle RAC环境，需要具体知道该用什么工具。

从之前的详细解答来看，用户对技术细节接受度很高，所以这次也要保持专业深度，但需要更聚焦在命令集本身。重点要突出GI的两大核心工具：crsctl和srvctl，同时补充一些配套工具。

用户可能特别关心日常维护场景，比如启停资源、查看状态、修改配置等。需要强调crsctl用于控制集群框架本身，而srvctl用于管理数据库资源。还要提醒特权命令需要root权限，比如crsctl start crs这种底层操作。

注意到之前解释过OCR和表决磁盘的概念，这里可以关联相关维护命令。比如crsctl query css votedisk这种命令就能对应到之前讲过的防脑裂机制。用户如果理解原理，会更容易记住命令用途。

另外，用户可能没意识到ASM命令也属于GI范畴，需要单独列出asmcmd和srvctl管理ASM实例的部分。故障诊断工具如ocrcheck、cluvfy也很实用，但容易被忽略，值得重点提醒。

最后要警告高危操作，比如crsctl stop crs会直接影响整个集群，必须谨慎。毕竟生产环境维护容错率低，用户需要明确知道每个命令的风险等级。

Grid Infrastructure (GI) 提供了一套**强大且核心的命令行工具**来管理和维护整个 RAC 集群环境（包括集群本身、ASM 以及运行在其上的数据库资源）。掌握这些命令是 Oracle DBA 和系统管理员进行日常维护、故障排除和性能调优的关键。

