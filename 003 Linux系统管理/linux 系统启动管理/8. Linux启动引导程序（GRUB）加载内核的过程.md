# 8. Linux启动引导程序（GRUB）加载内核的过程

在刚刚的启动过程中，我们已经知道启动引导程序（Boot Loader，也就是 GRUB）会在启动过程中加载内核，之后内核才能取代 BIOS 接管启动过程。如果没有启动引导程，那么内核是不能被加载的。

本节，我们就来看看启动引导程序加载内核的过程，当然 initramfs 这个虚拟文件系统也是要靠启动引导程序调用的。在 CentOS 6.x  中，启动引导程序默认是 GRUB，GRUB 是现在最为流行的启动引导程序，我们也用 GRUB 来说明启动引导程序的作用。

早期的 LILO 引导程序已经不是很常见了，GRUB 相比来讲有很多优势，主要有： *  支持更多的文件系统。

* GRUB 的主程序可以直接在文件系统中查找内核文件。
* 在系统启动时，可以利用 GRUB 的交互界面编辑和修改启动选项。
* 可以动态修改 GRUB 的配置文件，这样在修改配置文件之后不需要重新安装 GRUB，而只需重新启动就可以生效。

## GRUB加载内核的过程

GRUB 的作用有以下几个： *  加载操作系统的内核；

* 拥有一个可以让用户选择的的菜单，来选择到底启动哪个系统；
* 可以调用其他的启动引导程序，来实现多系统引导。

按照启动流程，BIOS 在自检完成后，会到第一个启动设备的 MBR 中读取 GRUB。在 MBR 中用来放置启动引导程序的空间只有 446  Byte，那么 GRUB 可以放到这里吗？答案是空间不够，GRUB 的功能非常强大，MBRM 空间是不够使用的。那么 Linux 的解决办法是把  GRUB 的程序分成了三个阶段来执行。

#### Stage 1：执行GRUB主程序

第一阶段是用来执行 GRUB 主程序的，这个主程序必须放在启动区中（也就是 MBR 或者引导扇区中）。但是 MBR 太小了，所以只能安装  GRUB 的最小的主程序，而不能安装 GRUB 的相关配置文件。这个主程序主要是用来启动 Stage 1.5 和 Stage 2 的。

#### Stage 1.5：识别不同的文件系统

Stage 2 比较大，只能放在文件系统中（分区），但是 Stage 1 不能识别不同的文件系统，所以不能直接加载 Stage 2。这时需要先加载 Stage 1.5，由 Stage 1.5 来加载不同文件系统中的 Stage 2。

还有一个问题，难道 Stage 1.5 不是放在文件系统中的吗？如果是，那么 Stage 1 同样不能找到 Stage 1.5。其实，Stage  1.5 还真没有放在文件系统中，而是在安装 GRUB 时，直接安装到紧跟 MBR 之后的 32KB  的空间中，这段硬盘空间是空白无用的，而且是没有文件系统的，所以 Stage 1 可以直接读取 Stage 1.5。读取了 Stage 1.5  就能识别不同的文件系统，才能加载 Stage 2。

#### Stage 2：加载GRUB的配置文件

Stage 2 阶段主要就是加载 GRUB 的配置文件 /boot/grub/grub.conf，然后根据配置文件中的定义，加载内核和虚拟文件系统。接下来内核就可以接管启动过程，继续自检与加载硬件模块了。
