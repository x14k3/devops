# 1. 核心交换机概念知识介绍

### 一、背板带宽

**1.交换机背板带宽含义**

交换机的背板带宽也叫背板容量，是交换机接口处理器或接口卡和数据总线间所能吞吐的最大数据量。背板带宽标志了交换机总的数据交换能力，单位为Gbps，一般的交换机的背板带宽从几Gbps到上百Gbps不等。一台交换机的背板带宽越高，所能处理数据的能力就越强，但同时设计成本也会越高。

**2.交换机的内部结构**

背板带宽资源的利用率与交换机的内部结构息息相关。目前交换机的内部结构主要有以下几种：

一是共享内存结构，这种结构依赖中心交换引擎来提供全端口的高性能连接，由核心引擎检查每个输入包以决定路由。这种方法需要很大的内存带宽、很高的管理费用，尤其是随着交换机端口的增加，中央内存的价格会很高，因而交换机内核成为性能实现的瓶颈。

二是交叉总线结构，它可在端口间建立直接的点对点连接，这对于单点传输性能很好，但不适合多点传输。

三是混合交叉总线结构，这是一种混合交叉总线实现方式，它的设计思路是，将一体的交叉总线矩阵划分成小的交叉矩阵，中间通过一条高性能的总线连接。其优点是减少了交叉总线数，降低了成本，减少了总线争用；但连接交叉矩阵的总线成为新的性能瓶颈。

**3.线性无阻塞传输**

我们购买交接机最佳性能，就是要求这款交换机做到了线性无阻塞传输。我们如何去考察一个交换机的背板带宽是否够用呢?如何去确定你买的交换机设计是否合理，存在阻塞的结构设计呢？

计算公式：

A、每种端口的速率 X 端口数量之和的2倍应该小于背板带宽，可实现全双工无阻塞交换，证明交换机具有发挥最大数据交换性能的条件。

B、满配置吞吐量(Mpps)=满配置GE端口数×1.488Mpps，其中1个千兆端口在包长为64字节时的理论吞吐量为1.488Mpps。例如，一台最多可以提供64个千兆端口的交换机，其满配置吞吐量应达到 64×1.488Mpps = 95.2Mpps，才能够确保在所有端口均线速工作时，提供无阻塞的包交换。

举例：如果一台交换机最多能够提供176个千兆端口，而宣称的吞吐量为不到261.8Mpps(176 x 1.488Mpps = 261.8)，那么用户有理由认为该交换机采用的是有阻塞的结构设计。

*对于万兆以太网，一个线速端口的包转发率为14.88Mpps。

*对于千兆以太网，一个线速端口的包转发率为1.488Mpps。

*对于快速以太网，一个线速端口的包转发率为0.1488Mpps。

*对于OC－12的POS端口，一个线速端口的包转发率为1.17Mpps。

*对于OC－48的POS端口，一个线速端口的包转发率为468MppS。

所以说，如果能满足上面两个条件，那么我们就说这款交换机真正做到了线性无阻塞;

交换机背板速率单位一般为Mbps，指的是二层，对于三层以上交换才采用Mpps  ，bps = bit/s，每秒比特数；pps = packet/s，每秒包数

**交换机的交换容量**（背板带宽|交换带宽）**计算方法为：端口数*相应端口速率*2（全双工）。例如一台24口百兆交换机交换容量=24*100*2=4800Mbit=4.8Gbps**

**交换机交换容量（背板带宽|交换带宽）和包转发率关系：** 交换容量 **=包转发速率*8*（64＋8＋12）*2 (全双工)=1344*包转发速率**

* 所以评价一台交换机，不能只看接口速率和接口数量，还要从包转发率和交换容量 **（背板带宽|交换带宽）** 一起来衡量一台交换机的性能。
* 一台24口百兆交换机，包转发率要达到3.5712Mpps，交换容量 **（背板带宽|交换带宽）** 要达到4.8Gbps。如果这两个参数不能达到这个值，就说明交换机的性能不达标。

### 二、交换容量

交换机的交换容量，是指交换机接口处理器或接口卡和数据总线间所能吞吐的最大数据量。交换容量表明了交换机总的数据交换能 力，单位是Gbps

交换机端口数量*相应端口速率*2(全双工)

48*1000Mbps*2=96000Mbps=96Gbps

交换机容量(交换机的总带宽，也称端口总带宽)   **≤ (小于等于)**  背板带宽

如果交换机容量小于等于背板带宽，那么背板带宽上是线速的。

H3C低端LSW交换均采用存储转发模式，交换容量的大小由缓存（BUFFER）的位宽及其总线频率决定。即，交换容量＝缓存位宽*缓存总线频率=96*133=12.8Gbps

H3C高端的交换机的 交换容量可以等于端口总容量的2倍，端口总容量＝2 *（n*100Mbps+m*1000Mbps）（n：表示交换机有n个100M端口，m：表示交换机有m个1000M端口）。—— 一般目前都是这种

### 三、包转发率

**交换机的包转发率（吞吐量|包转发能力）指的是交换机转发数据包的能力，单位是pps（包每秒)，也就是交换机每秒可以转发多少个数据包。—— 注所有端口的转发能力总和才是交换机的包转发率**

转发能力以能够处理最小包长来衡量，对于以太网最小包为**64Byte**（**由于以太网的冲突检测机制，所以以太网传输数据帧时对数据帧的大小有个限制，数据帧最小为64byte**），加上帧开销**20Byte**（**在以太网中，每个帧头都要加上了8个字节的前导符，前导符的作用在于告诉监听设备数据将要到来。然后，以太网中的每个帧之间都要有帧间隙，即每发完一个帧之后要等待一段时间再发另外一个帧，在以太网标准中规定最小是12个字节，然而帧间隙在实际应用中有可能会比12个字节要大，在这里我用了最小值。每个帧都要有20个字节的固定开销**），因此最小包为**84Byte**。

交换机接口速率：100Mbit/s的以太网接口，学过计算机的同学都知道，每8个bit组成一个字节，所以接一个百兆接口转换成节=12.5Mbyte/s，也就是说每秒这个以太网接口能转发12.5M个字节=12500000byte。**以此百兆以太口为例，一个百兆以太口每秒最多转发12500000byte的数据，假设在最糟糕的情况下所传输的所有数据帧都是最小的84byte（当然如果传输的数据帧越大对交换机转发越有利，所以我们这里假设一个极端，在最糟糕的情况下），那么这个百兆以太口每秒转发的数据帧为  12500000/84=148809pps(帧/秒或包每秒)=148.8kpps=0.1488Mpps。——注：1000000K=**   **1000M=1G**

**也可直接用下面公式：**

对于1个全双工10Gbps**接口**达到线速时要求：转发能力＝10000Mbps/((64+20)*8bit)＝14.88Mpps

对于1个全双工1000Mbps**接口**达到线速时要求：转发能力＝1000Mbps/((64+20)*8bit)＝1.488Mpps

对于1个全双工100Mbps**接口**达到线速时要求：转发能力＝100Mbps/((64+20)*8bit)＝0.149Mpps

单位：Mpps （兆个包每秒）

举个例子，假设有一台24口10/100Base-TX以太网交换机，那么这台交换机的包转发率为  24*0.1488Mpps=3.5712Mpps，如果再加上4个千兆以太口4*1.488Mpps=5.952Mpps。那么总共就是3.5712Mpps+5.952Mpps=9.5232Mpps。也就是说一台24口百兆+4口千兆的以太网交换机，只有整机包转发率达到9.5232Mpss的时候，才能实现线速转发。

### 四、示例

背板概念：我个人一直理解成电脑的总线。  
背板带宽 **（平时选型时可以等同于交换容量，下同）** 计算方式：每种端口的速率乘以端口数量之和，再乘以2

背板带宽：  
接入交换机的背板带宽：以24口接入交换机为例（24个千兆口）  
24*1000x 2(Mbit/s) /1000(Mbit/s)= 48 (Gbit/s)  
核心交换机的背板带宽：接入交换机数量乘以48 (Gbit/s)

**实验1：桌面型交换机带20台电脑上网**

设备：桌面型交换机（俗称傻瓜交换机）  
厂家公布的包转发率：35.7Mpps  
接口：24个10/100/1000Base-TX以太网端口， (就是24个1000M）  
计算：1.488Mpps*24 =35.712Mpps  
计算所得的包转发率：结果35.712Mpps =公布包转发率：35.7Mpps，满足全端口“线速转发”。

厂家公布的背板带宽：48Gbps

计算：24*1000x 2(Mbit/s) /1000(Mbit/s)= 48 (Gbit/s)

背板带宽：结果48 (Gbit/s)<=厂家公布的背板带宽：48Gbps，满足全端口

**实验2：某个公司有300台电脑上网，三层核心怎么选。初步预计要用15个千兆交换机。**

通过上面的实验已经证实，每一个交换机的包转发率要达到35.712Mpps，背板带宽要达到48 (Gbit/s)。

核心交换机背板带宽：接入交换机数量15X48 (Gbit/s)=720 Gbit/s

吞吐量包转发率：  
接入交换机的包转发率： 1.488Mpps*2 =2.976Mpps（解释：一个端口上联到核心，但是有上行和下行。）

核心交换机的包转发率：接入交换机数量15 X 2.976Mpps =44.64Mpps

---

‍

### 五、线速

线速是指交换机的端口上每秒钟传输的bit数，单位为bps（bit per  second，即每秒传输多少bit，一个bit也就是一个二进制数0或者1）。以我们常见的例子来说明的话，比如100M的网卡就是说的该网卡的网口线速为100Mbps；再比如安装的电信宽带是50M的宽带，说的是给我们开的端口线速度为50Mbps。

要注意的是，不要把线速和文件下载速度混为一谈了。在电脑上进行文件下载时的速度计算是以字节（byte）而不是以比特（bit）为单位的，我们通常说下载速度可以达到2M每秒意思是2Mbyte/s，也即2MBps，大写的B表示Byte，小写的b表示bit。那么byte和bit的区别是什么呢？其实也很简单，1byte=8bit，也即8倍的关系。

比如50M带宽的电信宽带，是指其线速是50Mbps，但其下载速度并不是50M，而是最大可以达到50M÷8=6.25MBps，当然这是理论值，实际使用过程中能做到满速下载的情况很少。

### 六、阻塞配置

全部交换端口的总带宽超过交换阵列的转发能力，数据流从接口模块进入背板时易发生阻塞，发生阻塞时，会降低系统交换性能。采用阻塞设计容易在千兆/百兆接口模块上提高端口密度，适合连接服务器。

### 七、非阻塞配置

全部交换端口的总带宽低于或等于交换阵列的转发能力，避免了数据进入背板时的阻塞发生。非阻塞设计适合主干连接，但接口模块的端口密度要和交换阵列的转发能力相匹配。构成高性能的网络主干，主干设备必须选择采用非阻塞配置满足用户需求的产品。

### 八、NP

网络处理器（Network  Processor，简称NP），网络处理器器件内部通常由若干个微码处理器和若干硬件协处理器组成，多个微码处理器在网络处理器内部并行处理，通过预先编制的微码来控制处理流程。而对于一些复杂的标准操作(如内存操作、路由表查找算法、QoS的拥塞控制算法、流量调度算法等)则采用硬件协处理器来进一步提高处理性能，从而实现了业务灵活性和高性能的有机结合。

### 九、交换模式

#### 9.1存储转发(Store and Forward)

特点：交换机接收到数据包后，首先将数据包存储到缓冲器中，进行CRC循环冗余校验,如果这个数据包有CRC错误，则该包将被丢弃；如果数据包完整，交换机查询地址映射表将其转发至相应的端口。  
优点：没有残缺数据包转发，可减少潜在的不必要的数据转发  
缺点：转发速率比直接转发方式慢。  
适用环境：存储转发技术适用于普通链路质量或质量较为恶劣的网络环境，这种方式要对数据包进行处理，所以，延迟和帧的大小有关。

#### 9.2直通交换(Cut—Through)

特点：交换机只读出数据帧的前6个字节，即通过地址映射表中查找目标地址，将数据帧传送到相应的端口上。直通交换能够实现较少的延迟，因为在数据帧的目的地址被读出，确定了转发端口后马上开始转发这个数据帧。  
优点：转发速率快、减少延时和提高整体吞吐率  
缺点：会给整个交换网络带来许多垃圾通信包  
适用环境：网络链路质量较好、错误数据包较少的网络环境，延迟时间跟帧的大小无关。

#### 9.3碎片丢弃（Fragmentfree）

特点：这是介于前两者之间的一种解决方案。它检查数据包的长度是否够64个字节，如果小于64字节，说明是假包，则丢弃该包；如果大于等于64字节，则发送该包。  
优点：数据处理速度比存储转发方式快  
缺点：比直通式慢  
适用环境：一般的通讯链路

### 十、级联

是最常见的连接方式，即使用网线将两个交换机连接起来。有使用光纤介质连接和双绞线介质连接两种情况。比较老的交换机有专门的级联端口，现在都没有了。

### 十一、堆叠

堆叠iStack（Intelligent   Stack），是指将多台支持堆叠特性的盒式交换机设备组合在一起，从逻辑上组合成一台整体交换设备，也就是说，堆叠中所有的交换机从拓扑结构上可视为一个交换机，便于统一管理。使用专用的堆叠线通过交换机上提供的堆叠接口使用一定的连接方式连接起来，也可以通过业务口进行堆叠。

### 十二、链路聚合

是将—组物理接口捆绑在一起作为一个逻辑接口来增加带宽及可靠性的方法。
