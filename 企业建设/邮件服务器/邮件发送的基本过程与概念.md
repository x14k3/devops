
### 1 电子邮件的发送和接收过程

和以往博客一样，LZ这里先给出用户A从QQ邮箱发送邮件到用户B163邮箱的图示，然后对图示的过程进行详细的介绍：

[[企业建设/邮件服务器/assets/cc43211ea5e0b41f5cec159832870b01_MD5.jpg|Open: 76b9c08d0e807005f22ca4a04df164d3_MD5.jpg]]
![[企业建设/邮件服务器/assets/cc43211ea5e0b41f5cec159832870b01_MD5.jpg|750]]

图示的六个步骤分别进行如下的说明：

1. 用户A的电子邮箱为：xx\@qq.com，通过邮件客户端软件写好一封邮件，交到QQ的邮件服务器，这一步使用的协议是SMTP,对应图示的①；
2. QQ邮箱会根据用户A发送的邮件进行解析，也就是根据收件地址判断是否是自己管辖的账户，如果收件地址也是QQ邮箱，那么会直接存放到自己的存储空间。这里我们假设收件地址不是QQ邮箱，而是163邮箱，那么QQ邮箱就会将邮件转发到163邮箱服务器，转发使用的协议也是SMTP，对应图示的②；
3. 163邮箱服务器接收到QQ邮箱转发过来的邮件，也会判断收件地址是否是自己，发现是自己的账户，那么就会将QQ邮箱转发过来的邮件存放到自己的内部存储空间，对应图示的③；
4. 用户A将邮件发送了之后，就会通知用户B去指定的邮箱收取邮件。用户B会通过邮件客户端软件先向163邮箱服务器请求，要求收取自己的邮件，对应图示的④；
5. 163邮箱服务器收到用户B的请求后，会从自己的存储空间中取出B未收取的邮件，对应图示⑤；
6. 163邮箱服务器取出用户B未收取的邮件后，将邮件发给用户B，对应图示的⑥；最后三步用户B收取邮件的过程，使用的协议是POP3;

上面的步骤可能大家不太明白，这里面出现了很多名词，比如邮件客户端软件，邮件服务器，SMTP和POP3协议（邮件传输协议）等等。不明白没关系，接下来我们来详细介绍这些名词。

### 2 邮件服务器

图示出现了两个邮件服务器，QQ和163邮件服务器。用户想要在网上收发邮件，必须要有专门的邮件服务器。邮件服务器我们可以假想为现实生活中的邮局。

如果按功能划分，邮件服务器可以划分为两种类型：

1. SMTP邮件服务器：用户替用户发送邮件和接收外面发送给本地用户的邮件，对应上图的第一、二步。它相当于现实生活中邮局的邮件接收部门（可接收普通用户要投出的邮件和其他邮局投递进来的邮件）。
2. POP3/IMAP邮件服务器：用户帮助用户读取SMTP邮件服务器接收进来的邮件，对应上图的第六步。它相当于专门为前来取包裹的用户提供服务的部门。

### 3 电子邮箱

电子邮箱也称为E-mail地址，比如用户A的xx\@qq.com，和用户B的xx\@163.com。用户能通过E-mail地址标识自己发送的电子邮件，同时也可以通过这个地址接收别人发来的电子邮件。电子邮箱需要到邮件服务器进行申请，也就是说，电子邮箱其实就是用户在邮件服务器上申请的账户。邮件服务器会把接收到的邮件保存到为该账户所分配的邮箱空间中，用户通过用户名密码登录到邮件服务器查收该地址已经收到的邮件。一般来讲，邮件服务器为用户分配的邮箱空间是有限的。

### 4 邮件客户端软件

我们可以直接在网站上进行邮件收发，也可以用邮件客户端软件。比如常见的FoxMail，Outlook Express。邮件客户端软件通常集邮件撰写，发送和收发功能于一体，主要用于帮助用户将邮件发送给SMTP邮件服务器和从POP3/IMAP邮件服务器读取用户的电子邮件。

### 5 邮件传输协议

电子邮件需要在邮件客户端和邮件服务器之间，以及两个邮件服务器之间进行邮件传递，那就必须要遵守一定的规则，这个规则就是邮件传输协议。下面我们分别简单介绍几种协议（后面会详细讲解）：

1. SMTP协议：全称为 Simple Mail Transfer Protocol，简单邮件传输协议。它定义了邮件客户端软件和SMTP邮件服务器之间，以及两台SMTP邮件服务器之间的通信规则。
2. POP3协议：全称为 Post Office Protocol，邮局协议。它定义了邮件客户端软件和POP3邮件服务器的通信规则。
3. IMAP协议：全称为 Internet Message Access Protocol,Internet消息访问协议，它是对POP3协议的一种扩展，也是定义了邮件客户端软件和IMAP邮件服务器的通信规则。

我们说所有的邮件服务器和邮件客户端软件程序都是基于上面的协议编写的。

#### 5.1 邮件发送 (SMTP)

负责将邮件“寄出”或“接收”到本服务器。

|端口|协议/加密|方向|用途|**重要说明**|
|---|---|---|---|---|
|**25**|SMTP (通常 STARTTLS)|**入站**|**服务器间投递**|**关键端口**。用于接收来自其他邮件服务器（如Gmail、腾讯企业邮）发来的邮件。**必须对公网开放**。|
|**587**|SMTP + STARTTLS|**入站**|**邮件提交**|**现代首选**。邮件客户端（Outlook、手机邮件App）**发送邮件**时使用。要求身份验证（用户名密码）。**必须对公网开放**。|
|**465**|SMTPS (隐式SSL/TLS)|**入站**|邮件提交（传统）|历史上用于安全的邮件提交。**已被587端口取代**，但仍有部分老客户端或服务商（如阿里云）要求使用。|
|25|SMTP (明文)|**出站**|向外部服务器发信|您的服务器需要能**访问外部的25端口**，才能向其他域名（如@[gmail.com](https://gmail.com/)）发送邮件。|

#### 5.2 邮件接收 (IMAP / POP3)

负责邮件客户端（如Outlook、Foxmail、手机邮件App）**收取和同步邮件**。

|端口|协议/加密|方向|用途|**重要说明**|
|---|---|---|---|---|
|**993**|IMAPS (SSL/TLS)|**入站**|**加密的IMAP**|**现代标准**。提供邮件同步（在服务器保留副本）。**必须对公网开放**。|
|**995**|POP3S (SSL/TLS)|**入站**|**加密的POP3**|提供邮件下载（默认从服务器删除）。**必须对公网开放**（如果需要使用POP3）。|
|143|IMAP + STARTTLS|入站|明文IMAP（可升级加密）|先建立明文连接，再通过`STARTTLS`命令加密。**建议关闭，强制使用993**。|
|110|POP3 + STARTTLS|入站|明文POP3（可升级加密）|同上。**建议关闭，强制使用995**。|

#### 5.3 Webmail 访问

通过浏览器访问邮箱。

|端口|协议|方向|用途|
|---|---|---|---|
|**443**|HTTPS (SSL/TLS)|**入站**|**安全的Webmail访问**（如Roundcube）|
|80|HTTP|入站|通常仅用于重定向到443（HTTPS）或申请SSL证书|

#### 5.4 管理与安全

|端口|协议|方向|用途|**重要说明**|
|---|---|---|---|---|
|4190|Sieve|入站|**管理邮件过滤器**|如果您使用`ManageSieve`协议（常见于Roundcube中设置过滤器），需要开放。|
|10025|自定义|本地|内部邮件处理|通常仅在**Docker容器间或本机内部**使用（如Amavis->Postfix），**不应对外开放**。|


#### 5.5 安全配置最佳实践总结

1. **对外必开端口 (入站规则)**:
    - `25 (SMTP)` - 收外部邮件
    - `587 (SMTP Submission)` - 客户端安全发信 **(最重要)**
    - `993 (IMAPS)` - 客户端安全收信/同步
    - `443 (HTTPS)` - Webmail
    - （可选）`465 (SMTPS)` - 备用发信端口
    - （可选）`995 (POP3S)` - 如需POP3

2. **必须关闭的端口 (强烈建议)**:
    - `110 (POP3明文)` 和 `143 (IMAP明文)` - 强制使用加密版本（995/993）。
    - 所有不必要的管理端口。

3. **出站规则**:
    - 您的服务器需要能**主动访问外部网络的 `25` 端口**，以便向外发信。
    - 需要能访问 `53 (DNS)` 端口进行域名解析。

4. **关键概念澄清**:
    - **`STARTTLS` vs `SSL/TLS`**：`STARTTLS`是在明文协议上“升级”到加密；`SSL/TLS`（如465、993）是一开始就建立加密连接。两者安全性相当，但实现方式不同。
    - **端口25 vs 587**：`25`是**服务器对服务器**，一般不需要认证；`587`是**客户端对服务器**，必须认证。这是防垃圾邮器的关键设计。

5. **特别注意**：
    - **云服务商封锁**：国内许多云服务器**默认封锁25号出站端口**，这会导致你无法向外域发邮件。购买服务器时需**专门申请解封**或使用云厂商的邮件中继服务。
    - **反向DNS (rDNS)**：你的服务器IP必须有正确的反向PTR记录指向你的邮件域名，否则很多外国服务器会拒收你的邮件。
    - **DNS记录**：除了MX记录，务必正确设置`SPF`、`DKIM`和`DMARC`记录，这与端口配置同等重要。

根据之前讨论的方案，**Mailcow**或**Docker Mailserver**都会默认使用这些最佳实践的端口配置。您只需在防火墙中按此清单放行即可。