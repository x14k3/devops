
## 1. 概述

### 1.1 版本

|帆软产品版本|功能变动|
|---|---|
|FineReport11.0.9信创版<br><br>FineBI6.0.4信创版<br><br>FineDataLink 4.0.19 信创版|-|

注：FineBI6.1及以上版本，仅支持使用信创版运维平台部署，不支持手动部署。详情请参见：[信创版运维平台与帆软应用部署](https://help.fanruan.com/fineXC/doc-view-68.html)

### 1.2 功能简介

有时用户需要将 FineReport/FineBI/FineDataLink 部署在东方通容器内进行使用。

支持部署的环境信息详情参见：[安装环境支持范围](https://help.fanruan.com/fineXC/doc-view-3.html)

注：用户需提前与中间件厂商联系，自行购买中间件授权并获取中间件安装包，帆软不提供相关资源和支持。

## 2. 部署方法

### 2.1 安装 TongWeb

将安装包上传到安装目录下例如：/opt/Tongweb，进入该目录执行

```
sh Install_TW6.1.5.7_Enterprise_Linux.bin -i console
```

进行安装，如下图所示：  

![[企业建设/信创/assets/a3d25b4c7149f2767b70751d9cbc5555_MD5.png]]

跟随指示点击电脑回车 enter ，如下图所示：

![[企业建设/信创/assets/78b5cb0c36e759e324c4b6c69f70abac_MD5.png]]

![[企业建设/信创/assets/012bf6cba8fa7bd476e090e74d3978d8_MD5.png]]

输入Y

![[企业建设/信创/assets/1f36dbb34810efa4405bf37629fbaaf4_MD5.png]]

选择 JDK 环境，选择1

![[企业建设/信创/assets/8331575dddfb0e9adef440d63a4a1abf_MD5.png]]

选择安装目录，可自定义选择安装目录位置，若选择默认路径则按 enter，等待安装即可，如下图所示：

![[企业建设/信创/assets/451851cdeab5db40c777a047460424c9_MD5.png]]

设置端口，若不需要修改端口的话，则按回车建 enter 即可，后续需要修改端口可以在安装目录的conf的tongweb.xml文件中修改，如下图所示：

![[企业建设/信创/assets/1d4b95e1867358723bce763393dfb47e_MD5.png]]

设置完端口后按回车 enter 退出即安装完成，如下图所示：

![[企业建设/信创/assets/c77a0b0f35cfa25c699d43bd820a9e51_MD5.png]]

### 2.2 启动 TongWeb 

示例中为进入 opt/Tongweb6.1/bin目录下，执行./startserver.sh启动 Tongweb ，如下图所示：

![[企业建设/信创/assets/ced04a5911aca9c4c84e8218f58d66ec_MD5.png]]

访问 http://ip:9060/console 进入控制台首页，9060为默认端口，默认系统管理员用户名及初始密码为：thanos/thanos123.com。，点击登录，如下图所示：

注：部分版本东方通默认系统管理员用户名及初始密码为：twnt/twnt123.com

![[企业建设/信创/assets/64123a0592e870a1e885a5e4ab7dcfd6_MD5.png]]

### 2.3 修改TongWeb参数

**1）修改URL编码格式**  

WEB容器配置>HTTP通道管理>tong-http-listenser>其他设置处，修改「URL编码格式」为「UTF-8」。

不修改会导致FineReport/FineBI工程中无法匹配中文名，服务器数据集处上传Excel后名称乱码。

![[企业建设/信创/assets/e6b3ea5314938f09b3c5f384a18ee88b_MD5.png]]

**2）修改编解码字符集**

容器配置中，修改「默认请求参数解码字符集」和「默认应答编码字符集」为「UTF-8」。

不修改会导致FineReport/FineBI工程中无法匹配中文名，服务器数据集处上传Excel后名称乱码。

![[企业建设/信创/assets/477b0614c300ad4044437e815ba21e62_MD5.png]]

**3）添加服务器启动参数**

启动参数配置>服务器参数设置处，添加/修改服务器启动参数-DWebModuleOnly=true

添加后必须重启TongWeb（交互界面提示会自动重启服务器，但实际并不会，必须手动重启）

不修改会导致TongWeb启动报错：

[2022-11-08 15:21:56 275] [SEVERE] [http-nio2-0.0.0.0-9060-exec-74] [core] [ContainerBase.addChild: start: ]  
com.tongweb.tomee.catalina.TomEERuntimeException: com.tongweb.tongejb.OpenEJBException: Unable to create annotation scanner for web module webroot: null

![[企业建设/信创/assets/1b41a841f233ac9e128f66e3be1fcf18_MD5.png]]

**4）修改tongweb.xml文件**

修改 conf/tongweb.xml 文件， <protocol not-allow-HTTP-methods 字段后的PUT和DELETE删除。

一共有三处，均需修改

不修改会导致tongweb容器的PUT/DELETE不可以使用。

![[企业建设/信创/assets/327565fcb464b6eb5c7e3c188a9d11f3_MD5.png]]

### 2.4 打war包

#### 方案一：

1）参考[设计器部署概述](https://help.fanruan.com/fineXC/doc-view-15.html)部署工程

2）Tongweb 部署FineReport11.0还需要加一些jar包到%Tongweb%/lib下才能部署上，详情请参见第三章附件。

3）在 FineReport 或者 FineBI 安装目录%FR_HOME%/webapps/webroot  下执行以下语句打 war 包

```
jar cvf webroot.war *
```

![[企业建设/信创/assets/ade41ef45a2605b9a63d6cd867d79232_MD5.png]]  

#### 方案二：

1）获取 webroot 压缩文件并将其上传至服务器中，如下图所示：

![[企业建设/信创/assets/0b94f557ec63c8ce134a5c1f7ad3aafc_MD5.png]]

2）上传文件后，进入上传位置，例如 /opt/applications，新建文件夹 webroot 并将文件解压至新建文件夹中：  

```
mkdir webrootunzip webroot.zip /opt/applications/webroot
```

3）Tongweb 部署FineReport11.0还需要加一些jar包到%Tongweb%/lib下才能部署上，详情请参见第三章附件。

4）执行以下语句对解压好的 webroot 打 war 包：

cd /opt/applications/webroot
jar cvf webroot.war *

### 2.5 部署应用

在控制台处点击「应用管理>部署应用」，如下图所示：

![[企业建设/信创/assets/73a48ab260c10e453f1ed549a274bd7c_MD5.png]]

选择 webroot.war 所在的位置，点击「开始部署」，如下图所示：

![[企业建设/信创/assets/21d2ca3d092a4e6e8c3a865047640ee1_MD5.png]]

默认设置，点击「下一步」，如下图所示：  

![[企业建设/信创/assets/80869241038c5e5f421cb3e5d9335817_MD5.png]]

选择虚拟主机位置，点击「下一步」，如下图所示：

![[企业建设/信创/assets/49501f476856ba294fd9f2935aaf9b32_MD5.png]]

点击「完成」，提示正在部署中，如下图所示：

![[企业建设/信创/assets/4b471ee79fdc461081c4a178466e2d5b_MD5.png]]

如果部署成功，应用的状态会显示已启动。

### 2.6 启动工程

访问http://ip:8088/webroot/decision（8088为默认端口，可自行修改），如下图所示：

![[企业建设/信创/assets/bfe41a6f272d719afe73b824f7d91a25_MD5.png]]

## 3. 注意事项

### 3.1 启动报错：java.lang.ClassNotFoundException

**问题描述：**

TongWeb 6.1.5.6 版本安装工程后，工程无法启动，%Tongweb%/logs存在类似报错：

![[企业建设/信创/assets/7fd02478738f68b0a1ed7f7052955ce2_MD5.png]]

**解决方案：**

1）下载以下JAR包：

[javax.ws.rs-api-2.1.1.jar](https://help.fanruan.com/fineXC/doc-download-/uploads/file/20200908/javax.ws.rs-api-2.1.1.jar "下载资料")

[jersey-media-sse-2.29.jar](https://help.fanruan.com/fineXC/doc-download-/uploads/file/20200908/jersey-media-sse-2.29.jar "下载资料")

[jersey-server-2.29.jar](https://help.fanruan.com/fineXC/doc-download-/uploads/file/20200908/jersey-server-2.29.jar "下载资料")

[jersey-common-2.29.jar](https://help.fanruan.com/fineXC/doc-download-/uploads/file/20200908/jersey-common-2.29.jar "下载资料")

2）将 JAR 包添加至%Tongweb%/lib 目录下，如下图所示：  

![[企业建设/信创/assets/6f771ca1d95a014d8fa0cf8eee8965ff_MD5.png]]

### 3.2 websocket开放

由于使用东方通容器自带的websocket，会存在线程不释放导致宕机的情况。因此不建议使用东方通自带的websocket，而是使用老socketio方案。

**1）禁用容器websocket方案**

信创版FineReport11.0.21/FineBI6.0.15及以上版本开始，默认禁用容器websocket方案，无需手动处理

信创版FineReport11.0.21/FineBI6.0.15之前版本，请手动在fine_conf_entity表里添加id为WebSocketConfig.useJavaxWebSocket、value为false的字段，并重启工程生效

**2）手动进行websocket配置**

用户需要手动对外开放websocket端口，进行websocket配置，详情请参见：

|场景|配置方法|
|---|---|
|单机环境配置 WebSocket 端口|[单机配置WebSocket端口](https://help.fanruan.com/finereport/doc-view-4130.html)|
|集群环境配置 WebSocket 端口|[集群配置WebSocket端口](https://help.fanruan.com/finereport/doc-view-4131.html)|
|HTTPS 环境配置 Websocket 端口|[HTTPS环境配置WebSocket](https://help.fanruan.com/finereport/doc-view-2662.html)|
|仅对外开放一个端口|[不额外给WebSocket对外开放端口](https://help.fanruan.com/finereport/doc-view-2854.html)|

### 3.3 启动报错：类冲突

**问题描述：**  

TongWeb 6.1.5.7 版本安装工程后，工程无法启动，%Tongweb%/logs存在类似报错：

javax.validation.spi.ConfigurationState.getClockProvider()Ljavax/validation/ClockProvider;类冲突

**原因分析：**  

TongWeb版本过低，自带的validation-api.jar与帆软应用的jar包出现冲突

**解决方案：**

1）关闭TongWeb，删除tongweb/lib/endorsed目录下的validation-api.jar。

2）下载并上传至tongweb/lib/endorsed目录下：

[validation-api-2.0.0.Final.jar](https://help.fanruan.com/fineXC/doc-download-/fineXC/uploads/file/20240123/validation-api-2.0.0.Final.jar "下载资料")

3）重启TongWeb，再尝试部署即可。

### 3.4 iframe无法访问

**问题描述：**  

TongWeb 安装工程后，工程可正常访问，但iframe访问失败，如下图所示：

![[企业建设/信创/assets/f7de2f2a151632ab172b014821e3a67a_MD5.png]]

**排查方案：**

1）请优先参考文档排查是否放开相关限制：[iframe集成模板报错](https://help.fanruan.com/finereport/doc-view-5085.html#bc10506fbd20f747)

2）TongWeb7在 external.vmoptions 中设置了相关参数:-Dtongweb.X_Frame_Options，请检查参数值是否允许网页被 Frame。

可设置参数值如下:

- DENY：浏览器拒绝当前页面加载任何 frame 页面
    
- SAMEORIGIN：frame 页面的地址只能为同源域名下的页面
    
- ALLOW-FROM：允许 frame 加载的页面地址。
    

![[企业建设/信创/assets/5de3dd3e073e8e51ed160169e27da4da_MD5.png]]