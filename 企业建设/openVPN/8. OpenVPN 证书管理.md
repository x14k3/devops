

## ç­¾å‘è¯ä¹¦

```bash
wget https://github.com/OpenVPN/easy-rsa/releases/download/v3.1.7/EasyRSA-3.1.7.tgz
tar -zxvf EasyRSA-3.1.7.tgz 
cd EasyRSA-3.1.7/
echo '
#å…¬å¸ä¿¡æ¯ï¼Œæ ¹æ®æƒ…å†µè‡ªå®šä¹‰
set_var EASYRSA_REQ_COUNTRY     "CN"
set_var EASYRSA_REQ_PROVINCE    "Bei Jing"
set_var EASYRSA_REQ_CITY        "Bei Jing"
set_var EASYRSA_REQ_ORG         "Copyleft Certificate Co"
set_var EASYRSA_REQ_EMAIL       "me@example.net"
set_var EASYRSA_REQ_OU          "My Organizational Unit"
#è¯ä¹¦æœ‰æ•ˆæœŸ
set_var EASYRSA_CA_EXPIRE       3650
set_var EASYRSA_CERT_EXPIRE     3650 ' >> vars


## åˆ›å»ºè¯ä¹¦
./easyrsa init-pki   			     	   #1ã€åˆå§‹åŒ–ï¼Œåœ¨å½“å‰ç›®å½•åˆ›å»ºPKIç›®å½•ï¼Œç”¨äºå­˜å‚¨æ•´æ•°
./easyrsa build-ca  			      	   #2ã€åˆ›å»ºæ ¹è¯ä¹¦ï¼Œä¼šæç¤ºè®¾ç½®å¯†ç ï¼Œç”¨äºcaå¯¹ä¹‹åç”Ÿæˆçš„serverå’Œclientè¯ä¹¦ç­¾åæ—¶ä½¿ç”¨ï¼Œå…¶ä»–æç¤ºå†…å®¹ç›´æ¥å›è½¦å³å¯
./easyrsa gen-req server-key nopass   	   #3ã€åˆ›å»ºserverç«¯è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œnopassè¡¨ç¤ºä¸åŠ å¯†ç§é’¥æ–‡ä»¶ï¼Œæç¤ºå†…å®¹ç›´æ¥å›è½¦å³å¯
./easyrsa sign server server-key     	   #4ã€ç»™serverç«¯è¯ä¹¦ç­¾åï¼Œæç¤ºå†…å®¹éœ€è¦è¾“å…¥yeså’Œåˆ›å»ºcaæ ¹è¯ä¹¦æ—¶å€™çš„å¯†ç 
./easyrsa gen-dh   				      	   #5ã€åˆ›å»ºDiffie-Hellmanæ–‡ä»¶ï¼Œå¯†é’¥äº¤æ¢æ—¶çš„Diffie-Hellmanç®—æ³•
./easyrsa gen-req client-desktop nopass    #6ã€åˆ›å»ºclientç«¯çš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œnopassè¡¨ç¤ºä¸åŠ å¯†ç§é’¥æ–‡ä»¶ï¼Œæç¤ºå†…å®¹ç›´æ¥å›è½¦å³å¯
./easyrsa sign client client-desktop       #7ã€ç»™clientç«¯è¯ä¹¦å‰é¢ï¼Œæç¤ºå†…å®¹è¾“å…¥yeså’Œåˆ›å»ºcaæ ¹è¯ä¹¦æ—¶å€™çš„å¯†ç 
openvpn --genkey --secret ta.key      	   #8ã€ç”Ÿæˆ ta.key æ–‡ä»¶ è¿™ä¸€æ­¥æ˜¯å¯é€‰æ“ä½œï¼Œç”Ÿæˆçš„ta.keyä¸»è¦ç”¨äºé˜²å¾¡DoSã€UDPæ·¹æ²¡ç­‰æ¶æ„æ”»å‡»ã€‚
```


## åŠé”€è¯ä¹¦

```bash
cd /path/to/easyrsa             # æ›¿æ¢ä¸ºä½ çš„ EasyRSA å®‰è£…è·¯å¾„
./easyrsa revoke "CLIENT_NAME"  # å°† CLIENT_NAME æ›¿æ¢ä¸ºå®¢æˆ·ç«¯è¯ä¹¦åç§°ï¼ˆå¦‚ client1ï¼‰

#ç³»ç»Ÿä¼šè¦æ±‚è¾“å…¥ CA å¯†ç ï¼ˆåˆ›å»º CA æ—¶è®¾ç½®çš„å¯†ç ï¼‰ã€‚
#åŠé”€æˆåŠŸåï¼Œä¼šæç¤ºÂ `Revocation was successful`ã€‚

./easyrsa gen-crl               # ç”Ÿæˆçš„ CRL æ–‡ä»¶é»˜è®¤åœ¨Â `pki/crl.pem`ã€‚

### é…ç½® OpenVPN æœåŠ¡å™¨ä½¿ç”¨ CRLï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å‚æ•°
crl-verify crl.pem

### é‡å¯ OpenVPN æœåŠ¡
systemctl restart openvpn-server@server  # æ ¹æ®å®é™…æœåŠ¡åè°ƒæ•´ï¼ˆå¦‚ openvpn@serverï¼‰
 
### éªŒè¯åŠé”€ç»“æœ
cat pki/index.txt
#è¢«åŠé”€çš„è¯ä¹¦çŠ¶æ€ä¼šæ ‡è®°ä¸ºÂ `R`ï¼ˆå¦‚Â `R 250408124310Z 230327124310Z 1001 unknown /CN=client1`ï¼‰ã€‚
```


## è¯ä¹¦è¿‡æœŸ

å½“OpenVPNå®¢æˆ·ç«¯è¯ä¹¦è¿‡æœŸæ—¶ï¼Œè‹¥ä¸æ›´æ¢æºè¯ä¹¦ï¼ˆCAè¯ä¹¦ï¼‰ï¼Œå¯é€šè¿‡**é‡æ–°ç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦**è§£å†³ã€‚ä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ï¼š

è§£å†³æ–¹æ¡ˆæ­¥éª¤ï¼š

1. **ç™»å½•OpenVPNæœåŠ¡å™¨**  
    è®¿é—®å­˜æ”¾CAè¯ä¹¦å’ŒEasyRSAå·¥å…·çš„æœåŠ¡å™¨ï¼ˆé€šå¸¸ä½äº`/etc/openvpn/server/`â€‹æˆ–`/etc/openvpn/easy-rsa/`â€‹ï¼‰ã€‚
2. **è¿›å…¥EasyRSAç›®å½•**

    ```
    cd /etc/openvpn/easy-rsa/  # è·¯å¾„å¯èƒ½å› å®‰è£…æ–¹å¼è€Œå¼‚
    ```
3. **åˆå§‹åŒ–ç¯å¢ƒï¼ˆè‹¥éœ€ï¼‰**

    ```
    source ./vars  # åŠ è½½ç¯å¢ƒå˜é‡
    ./easyrsa init-pki  # åˆå§‹åŒ–PKIï¼ˆè‹¥å·²å­˜åœ¨å¯è·³è¿‡ï¼‰
    ```
4. **ç­¾å‘æ–°å®¢æˆ·ç«¯è¯ä¹¦**

    ```
    ./easyrsa build-client-full <æ–°å®¢æˆ·ç«¯åç§°> nopass
    ```

    - â€‹ **â€‹`<æ–°å®¢æˆ·ç«¯åç§°>`â€‹** â€‹ï¼šè‡ªå®šä¹‰åç§°ï¼ˆå¦‚ `client2`â€‹ï¼‰ï¼Œä¸åŸå®¢æˆ·ç«¯åŒºåˆ†ã€‚
    - â€‹**â€‹`nopass`â€‹**â€‹ï¼šç”Ÿæˆæ— å¯†ç çš„è¯ä¹¦ï¼ˆè‹¥éœ€å¯†ç ä¿æŠ¤åˆ™ç§»é™¤æ­¤å‚æ•°ï¼‰ã€‚
5. **è·å–æ–°å®¢æˆ·ç«¯æ–‡ä»¶**  
    ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶ä½äºï¼š

    - **è¯ä¹¦**ï¼š`pki/issued/<æ–°å®¢æˆ·ç«¯åç§°>.crt`â€‹
    - **ç§é’¥**ï¼š`pki/private/<æ–°å®¢æˆ·ç«¯åç§°>.key`â€‹
6. **åˆ†å‘æ–‡ä»¶åˆ°å®¢æˆ·ç«¯**  
    å°†æ–°è¯ä¹¦å’Œç§é’¥æ–‡ä»¶å®‰å…¨ä¼ è¾“åˆ°å®¢æˆ·ç«¯è®¾å¤‡ï¼Œæ›¿æ¢åŸæ–‡ä»¶ï¼ˆé€šå¸¸ä¸`.ovpn`â€‹é…ç½®æ–‡ä»¶åŒç›®å½•ï¼‰ã€‚
7. **æ›´æ–°å®¢æˆ·ç«¯é…ç½®**  
    ä¿®æ”¹å®¢æˆ·ç«¯çš„`.ovpn`â€‹é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å‘æ–°è¯ä¹¦å’Œç§é’¥ï¼š  
    conf

    ```
    cert /path/to/<æ–°å®¢æˆ·ç«¯åç§°>.crt
    key /path/to/<æ–°å®¢æˆ·ç«¯åç§°>.key
    ```
8. **é‡å¯OpenVPNå®¢æˆ·ç«¯**  
    é‡æ–°è¿æ¥VPNå³å¯ç”Ÿæ•ˆã€‚

â€

---

åœ¨ä¸æ›´æ¢å®¢æˆ·ç«¯è¯ä¹¦çš„æƒ…å†µä¸‹è§£å†³OpenVPNè¯ä¹¦è¿‡æœŸé—®é¢˜ï¼Œéœ€é€šè¿‡**æœåŠ¡å™¨ç«¯è°ƒæ•´**æˆ–**å®¢æˆ·ç«¯ä¸´æ—¶æªæ–½**å®ç°ã€‚ä»¥ä¸‹æ˜¯å…·ä½“æ–¹æ¡ˆï¼š

â€

æ–¹æ¡ˆä¸€ï¼šæœåŠ¡å™¨ç«¯å¿½ç•¥è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆéœ€æ§åˆ¶æƒé™ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæ‚¨èƒ½ä¿®æ”¹OpenVPNæœåŠ¡å™¨é…ç½®  
**åŸç†**ï¼šåœ¨æœåŠ¡å™¨é…ç½®ä¸­è·³è¿‡è¯ä¹¦è¿‡æœŸéªŒè¯  
**æ­¥éª¤**ï¼š

1. **ä¿®æ”¹æœåŠ¡å™¨é…ç½®æ–‡ä»¶**ï¼ˆå¦‚ `server.conf`â€‹ï¼‰

    ```
    # æ·»åŠ ä»¥ä¸‹ä¸¤è¡Œ
    disable-occ  # å…³é—­é€‰é¡¹åå•†ï¼ˆéƒ¨åˆ†ç‰ˆæœ¬éœ€è¦ï¼‰
    verify-client-cert none  # è·³è¿‡å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ï¼ˆä»…é™OpenVPN 2.4+ï¼‰
    ```
2. **å¯ç”¨è‡ªå®šä¹‰éªŒè¯è„šæœ¬**ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰

    ```
    # åˆ›å»ºéªŒè¯è„šæœ¬
    echo '#!/bin/sh
    [ "$1" -eq 1 ] && exit 0  # æ·±åº¦1ï¼ˆå®¢æˆ·ç«¯è¯ä¹¦ï¼‰ç›´æ¥é€šè¿‡
    exit 1' > /etc/openvpn/allow-expired.sh
    chmod +x /etc/openvpn/allow-expired.sh
    ```

    åœ¨é…ç½®ä¸­æ·»åŠ ï¼š

    ```
    script-security 2
    tls-verify "/etc/openvpn/allow-expired.sh"
    ```
3. **é‡å¯OpenVPNæœåŠ¡**

    ```
    systemctl restart openvpn-server@server
    ```

---

â€

æ–¹æ¡ˆäºŒï¼šå®¢æˆ·ç«¯æ—¶é—´å›æº¯ï¼ˆä¸´æ—¶åº”æ€¥ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¿«é€Ÿä¸´æ—¶è¿æ¥  
**åŸç†**ï¼šä¿®æ”¹å®¢æˆ·ç«¯ç³»ç»Ÿæ—¶é—´è‡³è¯ä¹¦æœ‰æ•ˆæœŸå†…  
**æ­¥éª¤**ï¼š

1. **å…³é—­æ—¶é—´åŒæ­¥æœåŠ¡**

    ```
    sudo timedatectl set-ntp off  # Linux
    ```

    Windowsï¼š`Win+R`â€‹ â†’ `services.msc`â€‹ â†’ åœæ­¢ "Windows Time" æœåŠ¡
2. **ä¿®æ”¹ç³»ç»Ÿæ—¶é—´**

    ```
    sudo date -s "2023-01-01 12:00:00"  # è®¾ä¸ºè¯ä¹¦æœ‰æ•ˆæœŸå†…æ—¶é—´
    ```

    Windowsï¼šæ§åˆ¶é¢æ¿ â†’ æ—¥æœŸå’Œæ—¶é—´ â†’ æ‰‹åŠ¨è®¾ç½®æ—¥æœŸ
3. **è¿æ¥VPNåæ¢å¤æ—¶é—´**

    ```
    sudo timedatectl set-ntp on  # è¿æ¥æˆåŠŸåæ¢å¤åŒæ­¥
    ```

---

â€

æ–¹æ¡ˆä¸‰ï¼šè¯ä¹¦æœ‰æ•ˆæœŸå»¶å±•ï¼ˆæ— éœ€é‡ç­¾ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¯è®¿é—®CAä½†ä¸æƒ³é‡æ–°ç­¾å‘  
**åŸç†**ï¼šç›´æ¥å»¶é•¿åŸè¯ä¹¦æœ‰æ•ˆæœŸ  
**æ­¥éª¤**ï¼š

1. **å¤‡ä»½åŸè¯ä¹¦**

    ```
    cp client.crt client.crt.bak
    cp client.key client.key.bak
    ```
2. **å»¶é•¿è¯ä¹¦æœ‰æ•ˆæœŸ**

    ```
    openssl x509 -in client.crt -signkey client.key \
    -days 3650 -out new_client.crt  # å»¶é•¿10å¹´
    ```
3. **æ›´æ–°å®¢æˆ·ç«¯é…ç½®**

    ```
    cert /path/to/new_client.crt
    key /path/to/client.key  # ä½¿ç”¨åŸç§é’¥
    ```

---

â€

â€

é£é™©è¯´æ˜

|æ–¹æ¡ˆ|å®‰å…¨æ€§é£é™©|æ¨èåœºæ™¯|
| --------------| ---------------------------------------| --------------|
|æœåŠ¡å™¨ç«¯å¿½ç•¥|âš ï¸ æå¤§é™ä½å®‰å…¨æ€§ï¼ˆä¸­é—´äººæ”»å‡»é£é™©ï¼‰|å°é—­æµ‹è¯•ç¯å¢ƒ|
|æ—¶é—´å›æº¯|âš ï¸ å½±å“å…¶ä»–æ—¶é—´æ•æ„ŸæœåŠ¡|ç´§æ€¥å•æ¬¡è¿æ¥|
|è¯ä¹¦å»¶å±•|ğŸ” ç›¸å¯¹å®‰å…¨ï¼ˆä¿æŒå¯†é’¥ä¸å˜ï¼‰|é•¿æœŸè§£å†³æ–¹æ¡ˆ|
