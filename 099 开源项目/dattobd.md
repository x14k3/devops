# dattobd

## Linux 快照问题

Linux 有一些用于创建文件系统的即时写入时复制 （COW） “快照”的基本工具。其中最突出的是LVM和设备映射器（LVM就是在其上构建的）。不幸的是，两者都有限制，使它们不适合支持跨不同 Linux 环境的实时服务器快照。两者都要求计算机上有一个未使用的卷来跟踪 COW 数据。服务器（尤其是生产服务器）可能未预先配置所需的备用卷。此外，这些快照系统仅允许将只读卷设置为读写。进行实时备份需要卸载数据卷，设置其快照，装载快照，然后使用 `dd`​ 或 `rsync`​ 等工具将原始卷复制到安全位置。许多生产服务器根本无法在执行此操作所需的时间内关闭，之后 COW 卷中的所有新数据最终必须合并回原始卷（这需要更多的停机时间）。至少可以说，这是不切实际且极其黑客的。

Datto Block Driver （dattobd） 解决了上述问题，并将类似于 Windows 上的 VSS 的功能带到了广泛的 Linux 内核中。Dattobd 是一个用于时间点实时快照的开源 Linux 内核模块。Dattobd 可以加载到正在运行的 Linux 机器上（无需重新启动），并在拍摄快照时在原始卷上创建一个代表任何块设备的 COW 文件。在第一个快照之后，驱动程序将跟踪块设备的增量更改，因此可用于通过仅复制已更改的块来有效地更新现有备份。Dattobd 是一个真正的实时快照系统，它将使您的根卷保持运行和可用，而无需重新启动。

Dattobd 设计用于在任何 Linux 设备上运行，从小型测试虚拟机到实时生产服务器，对 I/O 或 CPU 性能的影响最小。由于驱动程序在块层工作，因此它支持最常见的文件系统，包括ext 2,3和4以及xfs（尽管不支持具有自己的块设备管理系统（如ZFS和BTRFS）的文件系统）。所有 COW 数据都在源块设备本身的文件中进行跟踪，无需使用备用卷即可进行快照。

## 执行增量备份

Dattobd 的主要预期用例是备份实时 Linux 系统。一般流程是拍摄快照，复制快照并将快照移动到“增量”模式。稍后，我们可以将增量备份移回快照模式，并有效地更新我们进行的第一个备份。然后，我们可以重复此过程以不断更新备份的映像。以下是在简单的 Ubuntu 12.04 安装上使用驱动程序以实现此目的的示例，该安装具有 `/dev/sda1`​ 上的单个根卷。在这种情况下，我们将复制到另一个（更大的）卷 挂载在 `/backups`​ .其他 Linux 发行版应该类似地工作，只是稍作调整。

‍

‍
