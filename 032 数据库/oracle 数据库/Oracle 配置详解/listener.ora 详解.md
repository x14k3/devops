# listener.ora 详解

文件位置：`$ORACLE_HOME/network/admin`​

## 1. **监听的作用**

* **监听客户端请求**  
  监听器运行在数据库服务器之上，与Oracle实例（可为多个）相关关联，是一个专门的进程process，在windows的服务项目或者Linux的运行进程列表中，都会看到对应的运行进程。Windows上名为TNSLSNR，Linux/Unix平台上是lsnrctl。监听器守候在服务器制定端口（默认为：1521），监听客户端的请求。
* **为客户端请求分配Server Process**  
  监听器只负责接听请求，之后将请求转接给Oracle Server  Process。在Oracle的服务模式下，客户端进程是不允许直接操作数据库实例和数据，而是通过一个服务进程Server  Process（也称为影子进程）作为代理。监听器接受到请求之后，就向操作系统（或者Dispatcher组件）要求fork（或分配）一个Server  Process与客户端相连。
* **注册实例服务**  
  本质上将，listener是建立实例和客户端进程之间联系的桥梁。Listener与实例之间的联系，就是通过注册的过程来实现的。注册的过程就是实例告诉监听器，它的数据库数据库实例名称instance_name和服务名service_names。监听器注册上这样的信息，对客户端请求根据监听注册信息，找到正确的服务实例名称。目前Oracle版本中，提供动态注册和静态注册两种方式。
* **错误转移failover**  
  Failover是RAC容错的一个重要方面功能，其功能是在数据库实例崩溃的时候，可以自动将请求转移到其他可用实例上的一种功能。可以提供很大程度上的可用性（Availability）功能。这个过程中，发现实例已经崩溃，并且将请求转移到其他实例上，就属于是listener的功能。
* **负载均衡**  
  在RAC架构中，Oracle实现了负载均衡。当一个客户请求到来时，Oracle会根据当前RAC集群环境中所有实例的负载情况，避开负载较高的实例，将请求转移到负载较低的实例进行处理。在早期RAC版本中，负载轻重的衡量是根据监听器当前维护连接数目来确定的，而不是实时查看多实例的负载。RAC环境中的监听器之间进行沟通通信。~

## 2. **静态监听与动态监听**

### ORACLE 静态监听

listener静态注册，参数是手动静态添加，与数据库无关。数据库监听启动无法确是否正确配置（配置错误SID监听也可以正常启动）。因此，lsnrctl中的status显示状态为“**UNKNOWN**”。即不保证能连通数据库。listener启动时，根据配置`listener.ora`​文件中配置信息进行实例注册。

静态监听配置如下：

```bash
# listener.ora Network Configuration File: /data/u01/app/oracle/product/19.3.0/db_1network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER=
  (SID_LIST=
    (SID_DESC=
      (SID_NAME = orcl)
      (ORACLE_HOME = /data/u01/app/oracle/product/19.3.0/db_1)
      (PROGRAM = extproc)
    )
  )

LISTENER=
  (DESCRIPTION=
    (ADDRESS_LIST=
      (ADDRESS=(PROTOCOL = tcp)(HOST = 172.16.184.131)(PORT = 1521))
      (ADDRESS=(PROTOCOL = ipc)(KEY = extproc))
    )
  )

ADR_BASE_LISTENER = /data/u01/app/oracle
```

### **ORACLE 动态监听**

listener动态注册，在instance启动的时候PMON进程根据`init.ora`​获取`instance_name`​,`service_names`​两个参数将实例和服务，监听启动时，会将实例注册到监听程序中，启动后状态是“**READY**”。

‍

‍

## 5. 数据库名、服务名、实例名的关系

### **数据库实例名（instance_name）**

数据库实例名是用于和操作系统进行联系的标识，就是说数据库和操作系统之间的交互用的是数据库实例名。实例名也被写入参数文件中，该参数为`instance_name`​。

数据库名和实例名可以相同也可以不同。在一般情况下，数据库名和实例名是一对一的关系，但如果在RAC环境中，数据库名和实例名是一对多的关系。

数据库实例名与`ORACLE_SID`​有什么关系？

虽然两者都表是oracle实例，但两者是有区别的。`instance_name`​是oracle数据库参数。而`ORACLE_SID`​是操作系统的环境变 量。`ORACLD_SID`​用于与操作系统交互，也就是说，从操作系统的角度访问实例名，必须通过`ORACLE_SID`​。且`ORACLE_SID`​必须与`instance_name`​的值一致，否则，你将会收到一个错误，在unix平台，是“ORACLE not available”,在winnt平台，是“TNS:协议适配器错误”。

### **数据库域名（db_domain）**

在分布式数据库系统中，不同版本的数据库服务器之间，不论运行的操作系统是unix或是windows，各服务器之间都可以通过数据库链路进行远程复制，数据库域名主要用于oracle分布式环境中的复制。举例说明如：

全国交通运政系统的分布式数据库，其中：

福建节点：fj.jtyz

福建厦门节点：xm.fj.jtyz

江西：jx.jtyz

江西上饶：sr.jx.jtyz

这就是数据库域名。

数据库域名存在于参数文件中，他的参数是`db_domain`​

### **全局数据库名（global_DBName）**

全局数据库名=数据库名+数据库域名，如前述福建节点的全局数据库名是：oradb.fj.jtyz

### **数据库服务名（service_name）**

从oracle9i版本开始，引入了一个新的参数，即数据库服务名。参数名`SERVICE_NAME`​。

如果数据库有域名，则数据库服务名就是全局数据库名；否则，数据库服务名与数据库名相同。

从oracle8i开始的oracle网络组件，数据库与客户端的连接主机串使用数据库服务名。之前用的是`ORACLE_SID`​,即数据库实例名。

‍
