# listener.ora 详解

　　文件位置：`$ORACLE_HOME/network/admin`​

## 一、什么是注册？

　　注册就是将数据库作为一个服务注册到监听程序。客户端不需要知道数据库名和实例名，只需要知道该数据库对外提供的服务名就可以申请连接到数据库。这个服务名可能与实例名一样，也有可能不一样。

　　在数据库服务器启动过程中，数据库服务器会向监听程序注册相应的服务（无论何时启动一个数据库，默认地都有两条信息注册到监听器中：数据库服务器对应的实例和服务。）

　　相当于是这样：在数据库服务器和客户端之间有一监听程序（Listener），在监听程序中，会记录相应数据库对应的服务名（一个数据库可能对应有多个服务名），当客户端需要连接数据库时，只需要提供服务名，就可以建立客户端和服务器之间的连接。

## 二、**静态监听与动态监听**

### 2.1 静态监听

　　静态注册，参数是手动静态添加，与数据库无关。数据库监听启动无法确是否正确配置（配置错误SID监听也可以正常启动）。因此，lsnrctl中的status显示状态为“**UNKNOWN**”。即不保证能连通数据库。listener启动时，根据配置`listener.ora`​文件中配置信息进行实例注册。

　　静态注册时，listener.ora中的GLOBAL_DBNAME向外提供服务名，listener.ora中的SID_NAME提供注册的实例名。

　　静态监听配置如下：

```bash
# listener.ora Network Configuration File: /data/u01/app/oracle/product/19.3.0/db_1network/admin/listener.ora
# Generated by Oracle configuration tools.
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (GLOBAL_DBNAME = orcl)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/dbhome_1)
      (SID_NAME = orcl)
     )
   )

LISTENER=
  (DESCRIPTION=
    (ADDRESS_LIST=
      (ADDRESS=(PROTOCOL = tcp)(HOST = 172.16.184.131)(PORT = 1521))
      (ADDRESS=(PROTOCOL = ipc)(KEY = extproc))
    )
  )

ADR_BASE_LISTENER = /data/u01/app/oracle
```

　　该文件表明数据库是单实例的，实例名为orcl，向外提供了的服务为：orcl

　　‍

　　cdp listener.ora配置模板

```ora
SID_LIST_LISTENER=
  (SID_LIST=
    (SID_DESC=
      (GLOBAL_DBNAME = fmsdb)   --db_unique_name
      (SID_NAME = fmsdb)        --instance_name
      (ORACLE_HOME = /u01/app/oracle/product/19.3.0/db_1)
    )
    (SID_DESC=
      (GLOBAL_DBNAME = pdb1)    --pdb_name
      (SID_NAME = fmsdb)        --instance_name
      (ORACLE_HOME = /u01/app/oracle/product/19.3.0/db_1)
    )
  )

LISTENER=
  (DESCRIPTION=
    (ADDRESS_LIST=
      (ADDRESS=(PROTOCOL = tcp)(HOST = 192.168.0.203)(PORT = 1521))
      (ADDRESS=(PROTOCOL = ipc)(KEY = extproc))
    )
  )

ADR_BASE_LISTENER = /u01/app/oracle
```

### 2.2 **动态监听**

　　动态注册，在instance启动的时候PMON进程根据`init.ora`​获取`instance_name`​,`service_names`​两个参数将实例和服务，监听启动时，会将实例注册到监听程序中，启动后状态是“**READY**”。

　　首先要在init.ora中指定instance_name,service_names两个参数的值。在sqlplus下通过`show parameter service_names`​ 和`show parameter instance_name`​可以查看这两个参数的值。

　　注册到监听器中的实例值从init.ora文件中的instance_name参数取得。如果该参数没有设定值，那么它将取init.ora文件中的db_name的值。

　　注册到监听器中的服务值从init.ora文件中的参数service_names取得。如果该参数没有设定值，数据库将拼接init.ora文件中的db_name和db_domain的值来注册自己。如果选择提供service_names值，您可以使用完全限定的名称（比如 orcl.oracle.com)或缩写的名称（比如orcl）。如果选择缩写的名称并设置了db_domain参数，注册到监听器中的服务将是 service_name值和db_domain值的拼接。

　　例如下面的设置将导致服务orcl.oracle.com被注册到监听器中：

　　db_domain=oracle.com

　　service_names=orcl ;

　　采取动态注册方法时，listener.ora中的内容如下：

```
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PLSExtProc)
      (ORACLE_HOME = D:\oracle\product\10.2.0\db_1)
      (PROGRAM = extproc)
    )
  ) 
```

　　补充：

　　感受一下Oracle数据库实例的动态监听注册细节。有如下这样一个规律，先总结在这里：

* 如果是先启动监听，后启动数据库实例，则动态监听会自动识别到启动的数据库实例；
* 在数据库实例正常运行的情况下重启监听，则数据库实例会等很长时间才能在动态监听中注册成功，大约需要1分钟的等待时间；
* 如果是先启动数据库实例，后启动监听，效果和②一样；
* 如果不希望长时间等待动态监听注册的过程，可以使用“alter system register;”命令加速。

　　‍

## 三、数据库名、服务名、实例名的关系

### **数据库实例名（instance_name）**

　　数据库实例名是用于和操作系统进行联系的标识，就是说数据库和操作系统之间的交互用的是数据库实例名。实例名也被写入参数文件中，该参数为`instance_name`​。

　　数据库名和实例名可以相同也可以不同。在一般情况下，数据库名和实例名是一对一的关系，但如果在RAC环境中，数据库名和实例名是一对多的关系。

　　数据库实例名与`ORACLE_SID`​有什么关系？

　　虽然两者都表是oracle实例，但两者是有区别的。`instance_name`​是oracle数据库参数。而`ORACLE_SID`​是操作系统的环境变 量。`ORACLD_SID`​用于与操作系统交互，也就是说，从操作系统的角度访问实例名，必须通过`ORACLE_SID`​。且`ORACLE_SID`​必须与`instance_name`​的值一致，否则，你将会收到一个错误，在unix平台，是“ORACLE not available”,在winnt平台，是“TNS:协议适配器错误”。

### **数据库域名（db_domain）**

　　在分布式数据库系统中，不同版本的数据库服务器之间，不论运行的操作系统是unix或是windows，各服务器之间都可以通过数据库链路进行远程复制，数据库域名主要用于oracle分布式环境中的复制。举例说明如：

　　全国交通运政系统的分布式数据库，其中：

　　福建节点：fj.jtyz

　　福建厦门节点：xm.fj.jtyz

　　江西：jx.jtyz

　　江西上饶：sr.jx.jtyz

　　这就是数据库域名。

　　数据库域名存在于参数文件中，他的参数是`db_domain`​

### **全局数据库名（global_DBName）**

　　全局数据库名=数据库名+数据库域名，如前述福建节点的全局数据库名是：oradb.fj.jtyz

### **数据库服务名（service_name）**

　　从oracle9i版本开始，引入了一个新的参数，即数据库服务名。参数名`SERVICE_NAME`​。

　　如果数据库有域名，则数据库服务名就是全局数据库名；否则，数据库服务名与数据库名相同。

　　从oracle8i开始的oracle网络组件，数据库与客户端的连接主机串使用数据库服务名。之前用的是`ORACLE_SID`​,即数据库实例名。

　　‍
